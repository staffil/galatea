{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>{% trans '비전 모드' %}</title>

<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --primary: #8b5cf6;
    --primary-dark: #7c3aed;
    --secondary: #ec4899;
    --success: #10b981;
    --danger: #ef4444;
    --bg-dark: #0a0a0f;
    --bg-card: rgba(20, 20, 30, 0.9);
    --text-primary: #ffffff;
    --text-secondary: #a0a0b0;
}

body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
}

/* 전체 레이아웃 */
.vision-container {
    position: relative;
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
}

/* AI 배경 이미지 */
.ai-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
}

.ai-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, 
        rgba(10,10,15,0.3) 0%, 
        rgba(10,10,15,0.7) 60%,
        rgba(10,10,15,0.95) 100%
    );
}

.ai-background img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: blur(1px);
}

/* 상단 헤더 */
.top-header {
    position: relative;
    z-index: 10;
    padding: 16px 20px;
    background: linear-gradient(180deg, rgba(10,10,15,0.95) 0%, rgba(10,10,15,0) 100%);
    display: flex;
    align-items: center;
    gap: 12px;
}

.ai-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.ai-info {
    flex: 1;
}

.ai-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.ai-status {
    font-size: 0.85rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse-status 2s infinite;
}

@keyframes pulse-status {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
}

.header-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(139, 92, 246, 0.2);
    border: 1px solid rgba(139, 92, 246, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s;
}

.header-icon:active {
    transform: scale(0.9);
    background: rgba(139, 92, 246, 0.3);
}

/* 탭 네비게이션 */
.tab-navigation {
    position: relative;
    z-index: 10;
    padding: 0 20px 12px;
    display: flex;
    gap: 10px;
}

.tab-btn {
    flex: 1;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.tab-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.tab-btn:active {
    transform: scale(0.97);
}

/* 웹캠 프리뷰 */
.webcam-preview {
    position: absolute;
    top: 140px;
    right: 20px;
    width: 100px;
    height: 140px;
    border-radius: 16px;
    overflow: hidden;
    border: 2px solid rgba(139, 92, 246, 0.5);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 5;
    background: rgba(0, 0, 0, 0.3);
}

#webcam {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 컨트롤 영역 */
.control-area {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    padding: 20px;
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    background: linear-gradient(0deg, 
        rgba(10,10,15,0.98) 0%, 
        rgba(10,10,15,0.9) 50%,
        rgba(10,10,15,0) 100%
    );
}

/* 버튼 그룹 */
.button-group {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.vision-btn {
    padding: 14px 28px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 50px;
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    transition: all 0.3s;
}

.vision-btn:active {
    transform: scale(0.95);
}

.vision-btn.active {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    animation: pulse-btn 2s infinite;
}

@keyframes pulse-btn {
    0%, 100% { box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3); }
    50% { box-shadow: 0 4px 24px rgba(239, 68, 68, 0.6); }
}

.record-btn {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #f093fb, #f5576c);
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.record-btn:active {
    transform: scale(0.9);
}

.record-btn.recording {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    animation: pulse-record 1.5s infinite;
}

@keyframes pulse-record {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    50% { 
        transform: scale(1.05);
        box-shadow: 0 8px 28px rgba(239, 68, 68, 0.7);
    }
}

/* 상태 메시지 */
.status-message {
    text-align: center;
    padding: 12px 16px;
    background: rgba(20, 20, 30, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    margin-bottom: 12px;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* 결과 카드 */
.result-cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    max-height: 220px;
    overflow-y: auto;
}

.result-card {
    background: rgba(20, 20, 30, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 16px;
    padding: 14px 16px;
}

.result-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    color: var(--primary);
    font-size: 0.85rem;
    font-weight: 600;
}

.result-content {
    color: var(--text-primary);
    font-size: 0.9rem;
    line-height: 1.5;
}

/* 오디오 플레이어 */
.audio-player {
    margin-top: 12px;
    padding: 12px;
    background: rgba(20, 20, 30, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
}

.audio-player audio {
    width: 100%;
    height: 40px;
}

/* 스크롤바 스타일 */
.result-cards::-webkit-scrollbar {
    width: 4px;
}

.result-cards::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 2px;
}

.result-cards::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 2px;
}

/* 로딩 애니메이션 */
.loading-dots {
    display: inline-flex;
    gap: 4px;
}

.loading-dots span {
    width: 6px;
    height: 6px;
    background: var(--primary);
    border-radius: 50%;
    animation: loading 1.4s infinite;
}

.loading-dots span:nth-child(2) { animation-delay: 0.2s; }
.loading-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes loading {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
}

/* 반응형 */
@media (min-width: 768px) {
    .result-cards {
        grid-template-columns: 1fr 1fr;
        max-height: none;
    }
.webcam-preview{
        width:200px ;
        height: 280px;
    }
}
</style>
</head>

<body>

        <!-- Header -->
    <header>
        {% if not user.is_authenticated %}
            {% include "common/app/notLoginHeader.html" %}
        {% else %}
            {% include "common/app/loginHeader.html" %}
        {% endif %}
    </header>
    <div class="vision-container">
        <!-- AI 배경 -->
        <div class="ai-background">
            {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="AI Character">
            {% else %}
                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
            {% endif %}
        </div>


        <!-- 탭 네비게이션 -->
        <div class="tab-navigation">
            <a href="/customer_ai/custom_app/{{llm_id}}/" class="tab-btn">
                <i class="fas fa-comment"></i>
                <span>TEXT</span>
            </a>
            <a href="/customer_ai/vision_app/{{llm_id}}/" class="tab-btn active">
                <i class="fas fa-eye"></i>
                <span>VISION</span>
            </a>
            <a href="/customer_ai/novel_app/{{llm_id}}/" class="tab-btn">
                <i class="fas fa-book"></i>
                <span>NOVEL</span>
            </a>
        </div>

        <!-- 웹캠 프리뷰 -->
        <div class="webcam-preview">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <!-- 컨트롤 영역 -->
        <div class="control-area">
            <!-- 버튼 그룹 -->
            <div class="button-group">
                <button class="vision-btn" id="vision-toggle">
                    <i class="fas fa-eye"></i>
                    <span id="vision-text">{% trans '비전 시작' %}</span>
                </button>
                <button class="record-btn" id="record-toggle">
                    <i class="fas fa-microphone" id="record-icon"></i>
                </button>
            </div>

            <!-- 상태 메시지 -->
            <div class="status-message" id="status-msg">
                {% trans '버튼을 눌러 시작하세요' %}
            </div>

            <!-- 결과 카드 -->
            <div class="result-cards">
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-microphone"></i>
                        <span>{% trans '음성 인식' %}</span>
                    </div>
                    <div class="result-content" id="recognized-text">
                        {% trans '대기 중...' %}
                    </div>
                </div>
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-robot"></i>
                        <span>{% trans 'AI 응답' %}</span>
                    </div>
                    <div class="result-content" id="ai-response">
                        {% trans '대기 중...' %}
                    </div>
                </div>
            </div>

            <!-- 오디오 플레이어 -->
            <div class="audio-player" id="audio-container" style="display: none;">
                <audio id="tts-audio" controls></audio>
            </div>
        </div>
    </div>

<script>
const baseUrl = window.location.pathname.replace(/\/(chat|vision|vision_app|custom_app|novel_app)\/\d+\/?$/, '');
const webcam = document.getElementById('webcam');
const canvas = document.createElement('canvas');
const visionToggle = document.getElementById('vision-toggle');
const visionText = document.getElementById('vision-text');
const recordToggle = document.getElementById('record-toggle');
const recordIcon = document.getElementById('record-icon');
const statusMsg = document.getElementById('status-msg');
const recognizedText = document.getElementById('recognized-text');
const aiResponse = document.getElementById('ai-response');
const ttsAudio = document.getElementById('tts-audio');
const audioContainer = document.getElementById('audio-container');

let streaming = false;
let visionInterval = null;
let isVisionRunning = false;
let latestVisionResult = '';
let isProcessing = false;

let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let audioStream;

// 웹캠 시작
async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        webcam.srcObject = stream;
        streaming = true;
        statusMsg.textContent = "{% trans '웹캠이 시작되었습니다' %}";
    } catch (err) {
        statusMsg.textContent = "{% trans '웹캠 접근 실패' %}";
        console.error(err);
    }
}

// 웹캠 중지
function stopWebcam() {
    if (webcam.srcObject) {
        webcam.srcObject.getTracks().forEach(t => t.stop());
        streaming = false;
    }
}

// 비전 모드 토글
visionToggle.addEventListener('click', async () => {
    if (!isVisionRunning) {
        if (!streaming) await startWebcam();
        isVisionRunning = true;
        visionInterval = setInterval(captureAndAnalyze, 2000);
        visionToggle.classList.add('active');
        visionText.textContent = "{% trans '비전 중지' %}";
        statusMsg.textContent = "{% trans '비전 분석 중...' %}";
    } else {
        clearInterval(visionInterval);
        stopWebcam();
        isVisionRunning = false;
        visionToggle.classList.remove('active');
        visionText.textContent = "{% trans '비전 시작' %}";
        statusMsg.textContent = "{% trans '비전 모드가 중지되었습니다' %}";
    }
});

// 프레임 캡처 및 분석
async function captureAndAnalyze() {
    if (!streaming || isProcessing) return;
    
    isProcessing = true;
    canvas.width = webcam.videoWidth;
    canvas.height = webcam.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(webcam, 0, 0);
    
    canvas.toBlob(async blob => {
        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');
        
        try {
            const res = await fetch(`${baseUrl}/vision_process/`, { method: 'POST', body: formData });
            const data = await res.json();
            latestVisionResult = data.result || '';
            statusMsg.innerHTML = `<i class="fas fa-eye"></i> ${latestVisionResult.substring(0, 50)}...`;
        } catch (err) {
            console.error(err);
        } finally {
            isProcessing = false;
        }
    }, 'image/jpeg');
}

// 녹음 토글
recordToggle.addEventListener('click', () => {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
});

// 녹음 시작
async function startRecording() {
    try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/wav";
        mediaRecorder = new MediaRecorder(audioStream, { mimeType });
        audioChunks = [];
        
        mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
        mediaRecorder.addEventListener("stop", handleRecordingStop);
        
        mediaRecorder.start();
        isRecording = true;
        recordToggle.classList.add('recording');
        recordIcon.className = "fas fa-stop";
        statusMsg.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span> {% trans "녹음 중..." %}';
    } catch (err) {
        statusMsg.textContent = "{% trans '마이크 권한을 허용해주세요' %}";
    }
}

// 녹음 중지
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        recordToggle.classList.remove('recording');
        recordIcon.className = "fas fa-microphone";
        statusMsg.textContent = "{% trans '음성 처리 중...' %}";
        if (audioStream) audioStream.getTracks().forEach(t => t.stop());
    }
}

// 녹음 완료 처리
function handleRecordingStop() {
    const mimeType = MediaRecorder.isTypeSupported("audio/webm") ? "audio/webm" : "audio/wav";
    const audioBlob = new Blob(audioChunks, { type: mimeType });
    const formData = new FormData();
    formData.append("audio", audioBlob, "recorded." + (mimeType.includes("webm") ? "webm" : "wav"));
    
    fetch(`${baseUrl}/upload_audio/`, { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.text) {
                recognizedText.textContent = data.text;
                sendToAI(data.text);
            } else {
                recognizedText.textContent = "{% trans '인식 실패' %}";
            }
        })
        .catch(err => {
            statusMsg.textContent = "{% trans '오류 발생' %}";
            console.error(err);
        });
}

// AI 응답 요청
async function sendToAI(text) {
    const formData = new FormData();
    formData.append('text', text);
    formData.append('vision', latestVisionResult);
    formData.append('llm_id', "{{ llm_id }}");
    
    aiResponse.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span>';
    
    try {
        const res = await fetch(`${baseUrl}/generate_response/`, { method: 'POST', body: formData });
        const data = await res.json();
        
        aiResponse.textContent = data.ai_text || "{% trans '응답 오류' %}";
        statusMsg.textContent = "{% trans '응답 완료' %}";
        
        if (data.conversation_id) {
            checkAudioStatus(data.conversation_id);
        }
    } catch (err) {
        aiResponse.textContent = "{% trans '오류 발생' %}";
        console.error(err);
    }
}

// 오디오 상태 확인
async function checkAudioStatus(conversationId) {
    const maxAttempts = 20;
    let attempts = 0;
    
    const interval = setInterval(async () => {
        attempts++;
        
        try {
            const res = await fetch(`${baseUrl}/check_audio_status/?conversation_id=${conversationId}`);
            const data = await res.json();
            
            if (data.ready && data.audio_url) {
                clearInterval(interval);
                ttsAudio.src = data.audio_url;
                audioContainer.style.display = 'block';
                ttsAudio.play().catch(e => console.warn("재생 오류:", e));
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                console.warn('오디오 생성 타임아웃');
            }
        } catch (err) {
            console.error(err);
        }
    }, 1000);
}

// 공유 기능
function shareLink() {
    const link = document.querySelector('[data-link]').getAttribute('data-link');
    if (navigator.share) {
        navigator.share({ url: link });
    } else {
        navigator.clipboard.writeText(link);
        statusMsg.textContent = '{% trans "링크가 복사되었습니다!" %}';
        setTimeout(() => statusMsg.textContent = '{% trans "준비 완료" %}', 2000);
    }
}
</script>
</body>
</html>