{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'í†µí™” ëª¨ë“œ' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/phone.css' %}">
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    


</head>

<body>
    <!-- Header -->
    <header class="header">
        {% if not user.is_authenticated %}
            {% include "common/notLoginHeader.html" %}
        {% else %}
            {% include "common/loginHeader.html" %}
        {% endif %}
    </header>
    
    <div class="hamburger" style="margin-top: 80px;" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3>ğŸ¯ {% trans 'ëª¨ë“œ ì„ íƒ' %}</h3>
            <div class="mode-options">
                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';">
                    <label><i class="fas fa-comment"></i> TEXT MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';">
                    <label><i class="fas fa-eye"></i> VISION MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/novel/{{llm_id}}';">
                    <label><i class="fas fa-book"></i> NOVEL MODE</label>
                </div>

                <div class="mode-option active">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/phone/{{llm_id}}';" checked>
                    <label><i class="fas fa-phone"></i> PHONE MODE</label>
                </div>
            </div>
            <button class="share-btn" data-link="{{ request.build_absolute_uri }}">
                {% trans 'ê³µìœ í•˜ê¸°' %}
            </button>
        </aside>

        <div class="background-blur"></div>
        
        <div class="phone-container">
            <!-- ìƒíƒœë°” -->
            <div class="status-bar">
                <div class="status-left">
                    <span id="currentTime">10:30</span>
                </div>
                <div class="status-right">
                    <div class="signal-bars">
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                    </div>
                    <span>ğŸ“¶</span>
                    <span>ğŸ”‹</span>
                </div>
            </div>

            <!-- í†µí™” ìƒíƒœ -->
            <div class="call-status">
                <div class="call-type">{% trans 'ìŒì„± í†µí™”' %}</div>
                <div class="call-duration" id="callDuration">00:00</div>
            </div>

            <!-- ë©”ì¸ í†µí™” ì •ë³´ -->
            <div class="call-info">
                {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="AI ì´ë¯¸ì§€" class="ai-image" />
                    <div class="speaking-ring" id="speakingRing"></div>
                {% else %}
                    <div class="caller-avatar">
                        <div class="speaking-ring" id="speakingRing"></div>
                        ğŸ¤–
                    </div>
                {% endif %}
                
                <div class="caller-name">{{ llm.name }}</div>
                <div class="caller-subtitle" id="callStatusText">{% trans 'ì—°ê²° ëŒ€ê¸° ì¤‘...' %}</div>
                <div class="call-quality">
                    <div class="signal-bars">
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                    </div>
                    <span>{% trans 'ê³ ìŒì§ˆ' %}</span>
                </div>
            </div>


            <!-- ë©”ì¸ í†µí™” ì»¨íŠ¸ë¡¤ -->
            <div class="call-controls">
                <button class="control-btn speaker" id="speakerBtn" onclick="toggleSpeaker()" title="{% trans 'ìŠ¤í”¼ì»¤' %}">ğŸ”Š</button>
                <button class="control-btn call-toggle" id="callToggleBtn" onclick="toggleCall()" title="{% trans 'í†µí™” ì‹œì‘/ì¢…ë£Œ' %}">ğŸ“</button>
                <button class="control-btn mute" id="muteBtn" onclick="toggleMute()" title="{% trans 'ìŒì†Œê±°' %}">ğŸ¤</button>
            </div>

            <!-- ìŒì„± ì¸ì‹ í…ìŠ¤íŠ¸ -->
            <div class="voice-transcript" id="voiceTranscript"></div>

            <!-- í™ˆ ì¸ë””ì¼€ì´í„° -->
            <div class="home-indicator"></div>
        </div>
    </div>

   <script>
        const llmId = "{{ llm_id }}";
        let isCallActive = false;
        let isSpeakerOn = false;
        let isMuted = false;
        let callStartTime = null;
        let callTimer = null;
        let mediaRecorder = null;
        let audioStream = null;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        async function startMicrophone() {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(audioStream);
            mediaRecorder.start(1000); // 1ì´ˆ ë‹¨ìœ„ ì²­í¬

            mediaRecorder.ondataavailable = async (event) => {
                if (!event.data || event.data.size === 0) return;
                if (isMuted) return;

                const chunkBlob = event.data;
                const formData = new FormData();
                formData.append('audio_chunk', chunkBlob);
                formData.append('llm_id', llmId);

                try {
                    const response = await fetch("{% url 'phone_process' %}", { method:'POST', body:formData });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.tts_url) playAudio(data.tts_url);
                        if (data.transcript) showVoiceTranscript(data.transcript);
                    }
                } catch(err) { console.error('ì˜¤ë””ì˜¤ ì „ì†¡ ì‹¤íŒ¨:', err); }
            };
        }

        function stopMicrophone() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(track => track.stop());
        }

        function playAudio(url) {
            fetch(url)
            .then(res => res.arrayBuffer())
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
            }).catch(err => console.error('TTS ì¬ìƒ ì‹¤íŒ¨:', err));
        }

        function toggleCall() {
            isCallActive = !isCallActive;
            const callToggleBtn = document.getElementById('callToggleBtn');
            const callStatusText = document.getElementById('callStatusText');
            const speakingRing = document.getElementById('speakingRing');

            if (isCallActive) {
                callToggleBtn.classList.add('active');
                callStatusText.textContent = '{% trans "í†µí™” ì¤‘..." %}';
                speakingRing.classList.add('active');
                callStartTime = Date.now();
                startCallTimer();
                showVoiceTranscript('{% trans "ìŒì„± í†µí™”ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." %}');
                startMicrophone();
            } else {
                callToggleBtn.classList.remove('active');
                callStatusText.textContent = '{% trans "ì—°ê²° ëŒ€ê¸° ì¤‘..." %}';
                speakingRing.classList.remove('active');
                stopCallTimer();
                showVoiceTranscript('{% trans "í†µí™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." %}');
                stopMicrophone();
            }
        }

        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            const speakerBtn = document.getElementById('speakerBtn');
            if (isSpeakerOn) {
                speakerBtn.classList.add('active');
                showVoiceTranscript('{% trans "ìŠ¤í”¼ì»¤ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤." %}');
            } else {
                speakerBtn.classList.remove('active');
                showVoiceTranscript('{% trans "ìŠ¤í”¼ì»¤ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤." %}');
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.classList.add('active');
                muteBtn.innerHTML = 'ğŸ”‡';
                showVoiceTranscript('{% trans "ë§ˆì´í¬ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤." %}');
            } else {
                muteBtn.classList.remove('active');
                muteBtn.innerHTML = 'ğŸ¤';
                showVoiceTranscript('{% trans "ë§ˆì´í¬ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤." %}');
            }
        }

        function startCallTimer() {
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime)/1000);
                const minutes = Math.floor(elapsed/60).toString().padStart(2,'0');
                const seconds = (elapsed%60).toString().padStart(2,'0');
                document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
            },1000);
        }

        function stopCallTimer() {
            if(callTimer){ clearInterval(callTimer); callTimer=null; }
            document.getElementById('callDuration').textContent='00:00';
        }

        function showVoiceTranscript(text) {
            const transcript = document.getElementById('voiceTranscript');
            transcript.textContent = text;
            transcript.style.display = 'block';
            setTimeout(()=>{ transcript.style.display='none'; }, 3000);
        }

        // í˜„ì¬ ì‹œê°„ í‘œì‹œ
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2,'0');
            const minutes = now.getMinutes().toString().padStart(2,'0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
        }

        updateTime();
        setInterval(updateTime,1000);
    </script>
</body>
</html>