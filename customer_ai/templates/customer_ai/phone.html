{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans '통화 모드' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/phone.css' %}">
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    


</head>

<body>
    <!-- Header -->
    <header class="header">
        {% if not user.is_authenticated %}
            {% include "common/notLoginHeader.html" %}
        {% else %}
            {% include "common/loginHeader.html" %}
        {% endif %}
    </header>
    
    <div class="hamburger" style="margin-top: 80px;" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3>🎯 {% trans '모드 선택' %}</h3>
            <div class="mode-options">
                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';">
                    <label><i class="fas fa-comment"></i> TEXT MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';">
                    <label><i class="fas fa-eye"></i> VISION MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/novel/{{llm_id}}';">
                    <label><i class="fas fa-book"></i> NOVEL MODE</label>
                </div>

                <div class="mode-option active">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/phone/{{llm_id}}';" checked>
                    <label><i class="fas fa-phone"></i> PHONE MODE</label>
                </div>
            </div>
            <button class="share-btn" data-link="{{ request.build_absolute_uri }}">
                {% trans '공유하기' %}
            </button>
        </aside>

        <div class="background-blur"></div>
        
        <div class="phone-container" style="overflow-y: auto;">
<br>
<br>

            <!-- 통화 상태 -->
            <div class="call-status">
                <div class="call-duration" id="callDuration">00:00</div>
            </div>

            <!-- 메인 통화 정보 -->
            <div class="call-info">
                {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="AI 이미지" class="ai-image" style="border-radius: 50%;"/>
                    <div class="speaking-ring" id="speakingRing"></div>
                {% else %}
                    <div class="caller-avatar">
                        <div class="speaking-ring" id="speakingRing"></div>
                        🤖
                    </div>
                {% endif %}
                
                <div class="caller-name">{{ llm.name }}</div>
                <div class="caller-subtitle" id="callStatusText">{% trans '녹음 대기 중...' %}</div>
                <div class="caller-subtitle" id="callStatusText">{% trans '녹음버튼을 누르면 시작, 한번더 누르면 종료가 됩니다!' %}</div>
                <div class="call-quality">

                </div>
            </div>


            <!-- 메인 통화 컨트롤 -->
            <div class="call-controls">
                <button class="control-btn call-toggle" id="callToggleBtn" onclick="toggleCall()" title="{% trans '통화 시작/종료' %}">🎙️</button>
            </div>

            <!-- 음성 인식 텍스트 -->
            <div class="voice-transcript" id="voiceTranscript"></div>

            <!-- 홈 인디케이터 -->
            <div class="home-indicator"></div>
        </div>
    </div>

{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans '통화 모드' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/phone.css' %}">
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        {% if user.is_authenticated %}
            {% include "common/loginHeader.html" %}
        {% else %}
            {% include "common/notLoginHeader.html" %}
        {% endif %}
    </header>

    <div class="phone-container">
     

        <div class="call-info">
            {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="AI 이미지" class="ai-image" />
                <div class="speaking-ring" id="speakingRing"></div>
            {% else %}
                <div class="caller-avatar">
                    <div class="speaking-ring" id="speakingRing"></div>
                    🤖
                </div>
            {% endif %}
            <div class="caller-name">{{ llm.name }}</div>
            <div class="caller-subtitle" id="callStatusText">{% trans '연결 대기 중...' %}</div>
        </div>

        <div class="call-controls">
            <button class="control-btn call-toggle" id="callToggleBtn" onclick="toggleCall()">🎙️</button>
        </div>

        <div class="voice-transcript" id="voiceTranscript"></div>
    </div>

<script>
const llmId = "{{ llm_id }}";
let isCallActive = false;
let isMuted = false;
let isSpeakerOn = false;
let callStartTime = null;
let callTimer = null;
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

let mediaStream = null;
let mediaRecorder = null;
let audioChunks = [];
let silenceTimeout = null;
const SILENCE_THRESHOLD = 0.02; // 소리 감지 민감도
const SILENCE_DELAY = 350; // 1.2초 침묵 감지
let isAISpeaking = false;
let isProcessing = false;
// ------------------ 통화 버튼 ------------------
function toggleCall() {
    isCallActive = !isCallActive;
    const btn = document.getElementById('callToggleBtn');
    const status = document.getElementById('callStatusText');
    const ring = document.getElementById('speakingRing');

    if (isCallActive) {
        btn.classList.add('active');
        status.textContent = '{% trans "녹음 중..." %}';
        ring.classList.add('active');
        callStartTime = Date.now();
        startCallTimer();
        showVoiceTranscript('{% trans "녹음이 시작되었습니다." %}');
        startVADRecording();
    } else {
        btn.classList.remove('active');
        status.textContent = '{% trans "녹음 대기 중..." %}';
        ring.classList.remove('active');
        stopCallTimer();
        showVoiceTranscript('{% trans "녹음이 종료되었습니다." %}');
        stopVADRecording();
    }
}

// ------------------ 음성 활동 기반 녹음 ------------------
async function startVADRecording() {
    if (!isCallActive) return;
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = function(e) {
    if (isMuted || isAISpeaking) return

        const input = e.inputBuffer.getChannelData(0);
        const max = Math.max(...input.map(Math.abs));

        if (max > SILENCE_THRESHOLD) {
            // 소리 감지됨 → 녹음 시작
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                if (!isAISpeaking) { // AI가 말하지 않을 때만 녹음 시작
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm;codecs=opus' });
                    mediaRecorder.ondataavailable = event => { if(event.data.size > 0) audioChunks.push(event.data); };
                    mediaRecorder.onstop = handleChunkUpload;
                    mediaRecorder.start();
                }
            }

            // 침묵 타이머 초기화
            if (silenceTimeout) clearTimeout(silenceTimeout);
            silenceTimeout = setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            }, SILENCE_DELAY);
        }
    };
}

function stopVADRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
}

// ------------------ 청크 업로드 및 LLM 처리 ------------------
async function handleChunkUpload() {
    if (!audioChunks.length) return;

    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append('audio', blob);
    formData.append('llm_id', llmId);

    try {
        // 1) Whisper 처리
        const resp = await fetch("{% url 'upload_audio' %}", { method:'POST', body: formData });
        if (resp.ok) {
            const data = await resp.json();
            if (data.text) {
                showVoiceTranscript(data.text); // 화면에 Whisper 텍스트 표시
                // 2) LLM 호출
                await handleLLMResponse(data.text, llmId, data.mp3_file);
            }
        }
    } catch(err) {
        console.error('청크 업로드 실패', err);
    }

    audioChunks = []; // 초기화
}

// ------------------ LLM 호출 ------------------
async function handleLLMResponse(userText, llmId, whisperMp3) {
    const formData = new FormData();
    formData.append('text', userText);
    formData.append('llm_id', llmId);

    try {
        const response = await fetch("{% url 'generate_response' %}", { method:'POST', body: formData });
        if (response.ok) {
            const data = await response.json();
            if (data.audio_url) playAudio(data.audio_url);        // AI TTS 재생
            if (data.ai_text) showVoiceTranscript(data.ai_text);   // AI 텍스트 표시
        } else {
            console.error('LLM 호출 실패', response.status);
        }
    } catch(err) {
        console.error('LLM 호출 에러', err);
    }
}

// ------------------ TTS 재생 ------------------
function playAudio(url) {
    isAISpeaking = true; // AI 발화 시작
        if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop(); // AI가 말할 때 기존 녹음 종료
    }
    fetch(url)
    .then(res => res.arrayBuffer())
    .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
    .then(audioBuffer => {
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();

        source.onended = () => { // AI 발화 종료 시
            isAISpeaking = false;
        };
    }).catch(err => console.error('TTS 재생 실패:', err));
}
// ------------------ 통화 시간 ------------------
function startCallTimer() {
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime)/1000);
        const minutes = String(Math.floor(elapsed/60)).padStart(2,'0');
        const seconds = String(elapsed%60).padStart(2,'0');
        document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
    },1000);
}

function stopCallTimer() {
    if(callTimer){ clearInterval(callTimer); callTimer=null; }
    document.getElementById('callDuration').textContent='00:00';
}

// ------------------ 스피커/마이크 ------------------
// function toggleSpeaker() {
//     isSpeakerOn = !isSpeakerOn;
//     const btn = document.getElementById('speakerBtn');
//     btn.classList.toggle('active', isSpeakerOn);
//     showVoiceTranscript(isSpeakerOn ? '{% trans "스피커 켜짐" %}' : '{% trans "스피커 꺼짐" %}');
// }

// function toggleMute() {
//     isMuted = !isMuted;
//     const btn = document.getElementById('muteBtn');
//     btn.classList.toggle('active', isMuted);
//     btn.textContent = isMuted ? '🔇' : '🎤';
//     showVoiceTranscript(isMuted ? '{% trans "마이크 꺼짐" %}' : '{% trans "마이크 켜짐" %}');
// }

// ------------------ 화면 텍스트 표시 ------------------
function showVoiceTranscript(text) {
    const t = document.getElementById('voiceTranscript');
    t.textContent = text;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.display='none'; }, 2000);
}
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

</script>

</body>
</html>