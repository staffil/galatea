{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'í†µí™” ëª¨ë“œ' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/phone.css' %}">
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    


</head>

<body>
    <!-- Header -->
    <header class="header">
        {% if not user.is_authenticated %}
            {% include "common/notLoginHeader.html" %}
        {% else %}
            {% include "common/loginHeader.html" %}
        {% endif %}
    </header>
    
    <div class="hamburger" style="margin-top: 80px;" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3>ğŸ¯ {% trans 'ëª¨ë“œ ì„ íƒ' %}</h3>
            <div class="mode-options">
                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';">
                    <label><i class="fas fa-comment"></i> TEXT MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';">
                    <label><i class="fas fa-eye"></i> VISION MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/novel/{{llm_id}}';">
                    <label><i class="fas fa-book"></i> NOVEL MODE</label>
                </div>

                <div class="mode-option active">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/phone/{{llm_id}}';" checked>
                    <label><i class="fas fa-phone"></i> PHONE MODE</label>
                </div>
            </div>
            <button class="share-btn" data-link="{{ request.build_absolute_uri }}">
                {% trans 'ê³µìœ í•˜ê¸°' %}
            </button>
        </aside>

        <div class="background-blur"></div>
        
        <div class="phone-container" style="overflow-y: auto;">
<br>
<br>

            <!-- í†µí™” ìƒíƒœ -->
            <div class="call-status">
                <div class="call-duration" id="callDuration">00:00</div>
            </div>

            <!-- ë©”ì¸ í†µí™” ì •ë³´ -->
            <div class="call-info">
                {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="AI ì´ë¯¸ì§€" class="ai-image" style="border-radius: 50%;"/>
                    <div class="speaking-ring" id="speakingRing"></div>
                {% else %}
                    <div class="caller-avatar">
                        <div class="speaking-ring" id="speakingRing"></div>
                        ğŸ¤–
                    </div>
                {% endif %}
                
                <div class="caller-name">{{ llm.name }}</div>
                <div class="caller-subtitle" id="callStatusText">{% trans 'ë…¹ìŒ ëŒ€ê¸° ì¤‘...' %}</div>
                <div class="caller-subtitle" id="callStatusText">{% trans 'ë…¹ìŒë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹œì‘, í•œë²ˆë” ëˆ„ë¥´ë©´ ì¢…ë£Œê°€ ë©ë‹ˆë‹¤!' %}</div>
                <div class="call-quality">

                </div>
            </div>


            <!-- ë©”ì¸ í†µí™” ì»¨íŠ¸ë¡¤ -->
            <div class="call-controls">
                <button class="control-btn call-toggle" id="callToggleBtn" onclick="toggleCall()" title="{% trans 'í†µí™” ì‹œì‘/ì¢…ë£Œ' %}">ğŸ™ï¸</button>
            </div>

            <!-- ìŒì„± ì¸ì‹ í…ìŠ¤íŠ¸ -->
            <div class="voice-transcript" id="voiceTranscript"></div>

            <!-- í™ˆ ì¸ë””ì¼€ì´í„° -->
            <div class="home-indicator"></div>
        </div>
    </div>

{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'í†µí™” ëª¨ë“œ' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/phone.css' %}">
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        {% if user.is_authenticated %}
            {% include "common/loginHeader.html" %}
        {% else %}
            {% include "common/notLoginHeader.html" %}
        {% endif %}
    </header>

    <div class="phone-container">
     

        <div class="call-info">
            {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="AI ì´ë¯¸ì§€" class="ai-image" />
                <div class="speaking-ring" id="speakingRing"></div>
            {% else %}
                <div class="caller-avatar">
                    <div class="speaking-ring" id="speakingRing"></div>
                    ğŸ¤–
                </div>
            {% endif %}
            <div class="caller-name">{{ llm.name }}</div>
            <div class="caller-subtitle" id="callStatusText">{% trans 'ì—°ê²° ëŒ€ê¸° ì¤‘...' %}</div>
        </div>

        <div class="call-controls">
            <button class="control-btn call-toggle" id="callToggleBtn" onclick="toggleCall()">ğŸ™ï¸</button>
        </div>

        <div class="voice-transcript" id="voiceTranscript"></div>
    </div>

<script>
const llmId = "{{ llm_id }}";
let isCallActive = false;
let isMuted = false;
let isSpeakerOn = false;
let callStartTime = null;
let callTimer = null;
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

let mediaStream = null;
let mediaRecorder = null;
let audioChunks = [];
let silenceTimeout = null;
const SILENCE_THRESHOLD = 0.02; // ì†Œë¦¬ ê°ì§€ ë¯¼ê°ë„
const SILENCE_DELAY = 350; // 1.2ì´ˆ ì¹¨ë¬µ ê°ì§€
let isAISpeaking = false;
let isProcessing = false;
// ------------------ í†µí™” ë²„íŠ¼ ------------------
function toggleCall() {
    isCallActive = !isCallActive;
    const btn = document.getElementById('callToggleBtn');
    const status = document.getElementById('callStatusText');
    const ring = document.getElementById('speakingRing');

    if (isCallActive) {
        btn.classList.add('active');
        status.textContent = '{% trans "ë…¹ìŒ ì¤‘..." %}';
        ring.classList.add('active');
        callStartTime = Date.now();
        startCallTimer();
        showVoiceTranscript('{% trans "ë…¹ìŒì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." %}');
        startVADRecording();
    } else {
        btn.classList.remove('active');
        status.textContent = '{% trans "ë…¹ìŒ ëŒ€ê¸° ì¤‘..." %}';
        ring.classList.remove('active');
        stopCallTimer();
        showVoiceTranscript('{% trans "ë…¹ìŒì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." %}');
        stopVADRecording();
    }
}

// ------------------ ìŒì„± í™œë™ ê¸°ë°˜ ë…¹ìŒ ------------------
async function startVADRecording() {
    if (!isCallActive) return;
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioContext.createMediaStreamSource(mediaStream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = function(e) {
    if (isMuted || isAISpeaking) return

        const input = e.inputBuffer.getChannelData(0);
        const max = Math.max(...input.map(Math.abs));

        if (max > SILENCE_THRESHOLD) {
            // ì†Œë¦¬ ê°ì§€ë¨ â†’ ë…¹ìŒ ì‹œì‘
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                if (!isAISpeaking) { // AIê°€ ë§í•˜ì§€ ì•Šì„ ë•Œë§Œ ë…¹ìŒ ì‹œì‘
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm;codecs=opus' });
                    mediaRecorder.ondataavailable = event => { if(event.data.size > 0) audioChunks.push(event.data); };
                    mediaRecorder.onstop = handleChunkUpload;
                    mediaRecorder.start();
                }
            }

            // ì¹¨ë¬µ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
            if (silenceTimeout) clearTimeout(silenceTimeout);
            silenceTimeout = setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
            }, SILENCE_DELAY);
        }
    };
}

function stopVADRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
}

// ------------------ ì²­í¬ ì—…ë¡œë“œ ë° LLM ì²˜ë¦¬ ------------------
async function handleChunkUpload() {
    if (!audioChunks.length) return;

    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append('audio', blob);
    formData.append('llm_id', llmId);

    try {
        // 1) Whisper ì²˜ë¦¬
        const resp = await fetch("{% url 'upload_audio' %}", { method:'POST', body: formData });
        if (resp.ok) {
            const data = await resp.json();
            if (data.text) {
                showVoiceTranscript(data.text); // í™”ë©´ì— Whisper í…ìŠ¤íŠ¸ í‘œì‹œ
                // 2) LLM í˜¸ì¶œ
                await handleLLMResponse(data.text, llmId, data.mp3_file);
            }
        }
    } catch(err) {
        console.error('ì²­í¬ ì—…ë¡œë“œ ì‹¤íŒ¨', err);
    }

    audioChunks = []; // ì´ˆê¸°í™”
}

// ------------------ LLM í˜¸ì¶œ ------------------
async function handleLLMResponse(userText, llmId, whisperMp3) {
    const formData = new FormData();
    formData.append('text', userText);
    formData.append('llm_id', llmId);

    try {
        const response = await fetch("{% url 'generate_response' %}", { method:'POST', body: formData });
        if (response.ok) {
            const data = await response.json();
            if (data.audio_url) playAudio(data.audio_url);        // AI TTS ì¬ìƒ
            if (data.ai_text) showVoiceTranscript(data.ai_text);   // AI í…ìŠ¤íŠ¸ í‘œì‹œ
        } else {
            console.error('LLM í˜¸ì¶œ ì‹¤íŒ¨', response.status);
        }
    } catch(err) {
        console.error('LLM í˜¸ì¶œ ì—ëŸ¬', err);
    }
}

// ------------------ TTS ì¬ìƒ ------------------
function playAudio(url) {
    isAISpeaking = true; // AI ë°œí™” ì‹œì‘
        if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop(); // AIê°€ ë§í•  ë•Œ ê¸°ì¡´ ë…¹ìŒ ì¢…ë£Œ
    }
    fetch(url)
    .then(res => res.arrayBuffer())
    .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
    .then(audioBuffer => {
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();

        source.onended = () => { // AI ë°œí™” ì¢…ë£Œ ì‹œ
            isAISpeaking = false;
        };
    }).catch(err => console.error('TTS ì¬ìƒ ì‹¤íŒ¨:', err));
}
// ------------------ í†µí™” ì‹œê°„ ------------------
function startCallTimer() {
    callTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime)/1000);
        const minutes = String(Math.floor(elapsed/60)).padStart(2,'0');
        const seconds = String(elapsed%60).padStart(2,'0');
        document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
    },1000);
}

function stopCallTimer() {
    if(callTimer){ clearInterval(callTimer); callTimer=null; }
    document.getElementById('callDuration').textContent='00:00';
}

// ------------------ ìŠ¤í”¼ì»¤/ë§ˆì´í¬ ------------------
// function toggleSpeaker() {
//     isSpeakerOn = !isSpeakerOn;
//     const btn = document.getElementById('speakerBtn');
//     btn.classList.toggle('active', isSpeakerOn);
//     showVoiceTranscript(isSpeakerOn ? '{% trans "ìŠ¤í”¼ì»¤ ì¼œì§" %}' : '{% trans "ìŠ¤í”¼ì»¤ êº¼ì§" %}');
// }

// function toggleMute() {
//     isMuted = !isMuted;
//     const btn = document.getElementById('muteBtn');
//     btn.classList.toggle('active', isMuted);
//     btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ¤';
//     showVoiceTranscript(isMuted ? '{% trans "ë§ˆì´í¬ êº¼ì§" %}' : '{% trans "ë§ˆì´í¬ ì¼œì§" %}');
// }

// ------------------ í™”ë©´ í…ìŠ¤íŠ¸ í‘œì‹œ ------------------
function showVoiceTranscript(text) {
    const t = document.getElementById('voiceTranscript');
    t.textContent = text;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.display='none'; }, 2000);
}
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

</script>

</body>
</html>