{% load static %} 
{% load i18n %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat UI</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<style>

</style>

<body>
    <!-- Header -->

<header class="header">
    {% if not user.is_authenticated %}
        {% include "common/notLoginHeader.html" %}
    {% else %}
        {% include "common/loginHeader.html" %}
    {% endif %}


</header>
    <div class="hamburger" style="margin-top: 50px;" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3>ğŸ¯ {% trans 'ëª¨ë“œ ì„ íƒ' %}</h3>
            <div class="mode-options">
                <div class="mode-option active">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';" checked>
                    <label><i class="fas fa-comment"></i> TEXT MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';">
                    <label><i class="fas fa-eye"></i> VISION MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/novel/{{llm_id}}';">
                    <label><i class="fas fa-book"></i> NOVEL MODE</label>
                </div>

                
                <!-- <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/phone/{{llm_id}}';">
                    <label><i class="fas fa-phone"></i> PHONE MODE</label>
                </div> -->
            </div>

    <button class="share-btn" data-link="{{ request.build_absolute_uri }}">
        {% trans 'ê³µìœ í•˜ê¸°' %}
    </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- AI Showcase -->
            <div class="ai-showcase">
                {% if llm.llm_image %}
                    <img src="{{ llm.llm_image.url }}" alt="AI ì´ë¯¸ì§€" class="ai-image" />
                {% endif %}
                
                <div class="chat-header">
                    <div class="ai-avatar">ğŸ¤–</div>
                    <h1 class="chat-title">{{ llm.name }}</h1>
                </div>
                <p class="chat-subtitle">{% trans 'í•˜ê³  ì‹¶ì€ ë§ì„ ì…ë ¥í•˜ì„¸ìš”' %}</p>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="message-area">
                <div class="message ai">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        {% trans 'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?' %}
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-row">
                    <input type="text" class="text-input" id="text-input" 
                           placeholder="{% trans 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...' %}" 
                           onkeydown="if(event.key === 'Enter'){ sendText(); }">
                    <button class="send-btn" onclick="sendText()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                

                
                <div class="recognized-text" id="recognized-text"></div>
                
                <!-- Audio Player -->
                <div class="audio-player" id="audio-container" style="display: none;">
                    <audio id="tts-audio" controls></audio>
                </div>
            </div>
        </main>
    </div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let stream;

    const baseUrl = window.location.pathname.replace(/\/(chat|vision)\/\d+\/?$/, '');

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    function toggleRecording() {
        const recordBtn = document.getElementById("record-btn");
        const recordIcon = document.getElementById("record-icon");
        const recordStatus = document.getElementById("record-status");

        if (!isRecording) {
            navigator.mediaDevices
                .getUserMedia({ audio: true })
                .then((s) => {
                    stream = s;
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;

                    recordIcon.className = "fas fa-stop";
                    recordBtn.classList.add("recording");
                    recordStatus.textContent = "{% trans 'ë…¹ìŒ ì¤‘... ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤' %}";

                    mediaRecorder.addEventListener("dataavailable", (event) => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                        const formData = new FormData();
                        formData.append("audio", audioBlob, "recorded.wav");

                        fetch(`${baseUrl}/upload_audio/`, {
                            method: "POST",
                            body: formData,
                        })
                        .then((res) => res.json())
                        .then((data) => {
                            const recognizedText = document.getElementById("recognized-text");
                            recognizedText.textContent = "{% trans 'ì¸ì‹ëœ í…ìŠ¤íŠ¸: ' %}" + data.text;
                            recognizedText.style.display = "block";
                            setTimeout(() => {
                                recognizedText.style.display = "none";
                            }, 3000);
                            
                            sendText(data.text);

                            if (data.audio_url) {
                                const audioElem = document.getElementById("tts-audio");
                                audioElem.src = data.audio_url;
                                document.getElementById("audio-container").style.display = "block";
                                audioElem.play();
                            }
                        })
                        .catch((error) => {
                            alert("{% trans 'ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' %}" + error.message);
                        });
                    });
                })
                .catch((err) => {
                    alert("{% trans 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' %}");
                    console.error(err);
                });
        } else {
            mediaRecorder.stop();
            isRecording = false;
            recordIcon.className = "fas fa-microphone";
            recordBtn.classList.remove("recording");
            recordStatus.textContent = "{% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”' %}";
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }
    }

    function sendText(text = null) {
        const currentLlmId = "{{ llm_id }}";
        const userText = text || document.getElementById("text-input").value;
        const llmImageUrl = "{{ llm.llm_image.url }}";
        
        if (!userText.trim()) return;

        const messageArea = document.getElementById("message-area");

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        const userMessage = document.createElement("div");
        userMessage.className = "message user";
        userMessage.innerHTML = `
            <div class="message-avatar">ğŸ‘¤</div>
            <div class="message-content">${userText}</div>
        `;
        messageArea.appendChild(userMessage);

        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById("text-input").value = "";
        
        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        messageArea.scrollTop = messageArea.scrollHeight;

        const formData = new FormData();
        formData.append("text", userText);
        formData.append("llm_id", currentLlmId);

        fetch(`${baseUrl}/generate_response/`, {
            method: "POST",
            body: formData,
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => { throw new Error(err.error || "Unknown error"); });
            }
            return res.json();
        })
        .then(data => {
            const aiMessage = document.createElement("div");
            aiMessage.className = "message ai";
            
            const avatarImg = llmImageUrl ? 
                `<img src="${llmImageUrl}" alt="AI" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : 
                'ğŸ¤–';
                
            aiMessage.innerHTML = `
                <div class="message-avatar">${avatarImg}</div>
                <div class="message-content">${data.ai_text}</div>
            `;
            messageArea.appendChild(aiMessage);

            if(data.audio_url){
                const audioElem = document.getElementById("tts-audio");
                audioElem.src = data.audio_url;
                document.getElementById("audio-container").style.display = "block";
                audioElem.play();
            }

            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            messageArea.scrollTop = messageArea.scrollHeight;
        })
        .catch(error => {
            alert("{% trans 'ì˜¤ë¥˜ ë°œìƒ: ' %}" + error.message);
        });
    }

    // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        
        if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
            if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
                sidebar.classList.remove('active');
                hamburger.classList.remove('active');
            }
        }
    });

    // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ë¦¬ì…‹
    window.addEventListener('resize', () => {
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        
        if (window.innerWidth > 1024) {
            sidebar.classList.remove('active');
            hamburger.classList.remove('active');
        }
    });

    // ë§í¬ ë³µì‚¬í•˜ê¸°
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("share-btn")) {
        const link = e.target.getAttribute("data-link");
        navigator.clipboard.writeText(link).then(() => {
            alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        });
    }
});
</script>

</body>
</html>