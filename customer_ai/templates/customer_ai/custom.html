{% load static %} 
{% load i18n %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat UI</title>
        <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
</head>

<style>
.message-wrapper {
    display: flex-start; 
    align-items: flex-start; 
    justify-content: flex-start;
    gap: 10px; 
}

.ai-image {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0; 
    position: relative;
    bottom: 70px;
    right: 20px;
}

.message-area {
    flex: 1; /* ë‚¨ëŠ” ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
}


</style>
<body>
    <!-- í—¤ë” -->
      <header>
    {% if not user.is_authenticated %}
      {% include "common/notLoginHeader.html" %}
    {% else %}
      {% include "common/loginHeader.html" %}
    {% endif %}
  </header>

    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
      <aside class="sidebar">
    <h3>ğŸ¯ {% trans 'ëª¨ë“œ ì„ íƒ' %}</h3>
    <div class="mode-option active">
        <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';" checked>
        <label>ğŸ’¬ TEXT MODE</label>
    </div>
    <div class="mode-option">
        <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';">
        <label>ğŸ‘ï¸ VISION MODE</label>
    </div>
  </aside>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
         <div class="chat-container">
    <div class="background" 
         {% if llm.llm_background_image %}
         style="background-image: url('{{ llm.llm_background_image.url }}');"
         {% endif %}>
    </div>
        <main class="chat-container">
            {% if llm.llm_image %}
                <img src="{{ llm.llm_image.url }}" alt="AI ì´ë¯¸ì§€" style="max-width: 700px; max-height: 400px; border-radius: 15px; margin-top: 50px;" />
            {% else %}
                <p>{% trans 'ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'%}</p>
            {% endif %}

            <div class="chat-header">
                <div class="ai-avatar">ğŸ—¨ï¸</div>
                <h1 class="chat-title">{{ llm.name }} {% trans 'í…ìŠ¤íŠ¸ ëŒ€í™”í•˜ê¸°'%}</h1>
            </div>
            
            <p class="chat-subtitle">{% trans 'í•˜ê³  ì‹¶ì€ ë§ì„ ì…ë ¥í•˜ì„¸ìš”'%}</p>
<div class="message-wrapper">
        
            <!-- ë©”ì‹œì§€ ì˜ì—­ì„ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ìœ„ë¡œ ì´ë™ -->
            <div class="message-area" id="message-area">
                <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                         <div class="ai-image" id="ai-image">

            </div>
            </div>

    
          </div>
  
            <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ë¥¼ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ìœ„ë¡œ ì´ë™ -->
            <div class="audio-player" id="audio-container" style="display: none;">
                <audio id="tts-audio" controls></audio>
            </div>
            
            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ì°½ì„ ë©”ì‹œì§€ ì˜ì—­ ì•„ë˜ë¡œ ì´ë™ -->
            <input type="text" class="text-input" id="text-input" placeholder="{% trans 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...' %}" onkeydown="if(event.key === 'Enter'){ sendText(); }">
            
            <!-- ë§ˆì´í¬ë¥¼ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ì•„ë˜ë¡œ ì´ë™ -->
            <div class="record-container">
                <button class="record-button" id="record-btn" onclick="toggleRecording()">
                    <span class="record-icon" id="record-icon">ğŸ¤</span>
                </button>
            </div>
            <div class="record-status" id="record-status">{% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”'%}</div>
            
            <div class="recognized-text" id="recognized-text"></div>
            </div>
        </main>
    </div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let stream;

    // í˜„ì¬ URLì—ì„œ /chat/1/ ë˜ëŠ” /vision/1/ ë¶€ë¶„ ì œê±°í•´ì„œ ê¸°ë³¸ URL ì¶”ì¶œ
    const baseUrl = window.location.pathname.replace(/\/(chat|vision)\/\d+\/?$/, '');

    function toggleRecording() {
        const recordBtn = document.getElementById("record-btn");
        const recordStatus = document.getElementById("record-status");

        if (!isRecording) {
            navigator.mediaDevices
                .getUserMedia({ audio: true })
                .then((s) => {
                    stream = s;
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;

                    recordBtn.querySelector(".record-icon").textContent = "â¹";
                    recordBtn.classList.add("recording");
                    recordBtn.parentElement.classList.add("recording");
                    recordStatus.textContent = "{% trans 'ë…¹ìŒ ì¤‘... ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤' %}";

                    mediaRecorder.addEventListener("dataavailable", (event) => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                        const formData = new FormData();
                        formData.append("audio", audioBlob, "recorded.wav");

                        fetch(`${baseUrl}/upload_audio/`, {
                            method: "POST",
                            body: formData,
                        })
                        .then((res) => res.json())
                        .then((data) => {
                            document.getElementById("recognized-text").textContent = "{% trans 'ì¸ì‹ëœ í…ìŠ¤íŠ¸: ' %}" + data.text;
                            sendText(data.text);

                            if (data.audio_url) {
                                const audioElem = document.getElementById("tts-audio");
                                audioElem.src = data.audio_url;
                                document.getElementById("audio-container").style.display = "block";
                                audioElem.play();
                            }
                        })
                        .catch((error) => {
                            alert("{% trans 'ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' %}" + error.message);
                        });
                    });
                })
                .catch((err) => {
                    alert("{% trans 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' %}");
                    console.error(err);
                });
        } else {
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.querySelector(".record-icon").textContent = "ğŸ¤";
            recordBtn.classList.remove("recording");
            recordBtn.parentElement.classList.remove("recording");
            recordStatus.textContent = "{% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”' }";
        }
    }

    function sendText(text = null) {
        const currentLlmId = "{{ llm_id }}";
        const userText = text || document.getElementById("text-input").value;
        if (!userText.trim()) return;

        const messageArea = document.getElementById("message-area");

        const aiImageArea = document.getElementById('ai-image')

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        const userMessage = document.createElement("div");
        userMessage.className = "user-message";
        userMessage.textContent = userText;
        messageArea.appendChild(userMessage);

        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById("text-input").value = "";

        // ë©”ì‹œì§€ ì¶”ê°€ í›„ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
        setTimeout(() => {
            const textInput = document.getElementById("text-input");
            textInput.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 100);

        const formData = new FormData();
        formData.append("text", userText);
        formData.append("llm_id", currentLlmId);

        fetch(`${baseUrl}/generate_response/`, {
            method: "POST",
            body: formData,
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => { throw new Error(err.error || "Unknown error"); });
            }
            return res.json();
        })
        .then(data => {
            const aiMessage = document.createElement("div");
            const aiImage = document.createElement('img');
            aiMessage.className = "ai-message";
            aiMessage.textContent = data.ai_text;

            aiImage.className = 'ai-image';
            aiImage.src = "{{ llm.llm_image.url }}"

            messageArea.appendChild(aiMessage);
            aiImageArea.appendChild(aiImage)
            

            if(data.audio_url){
                const audioElem = document.getElementById("tts-audio");
                audioElem.src = data.audio_url;
                document.getElementById("audio-container").style.display = "block";
                audioElem.play();
            }

            setTimeout(() => {
                const textInput = document.getElementById("text-input");
                textInput.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 100);
        })
        .catch(error => {
            alert("{% trans 'ì˜¤ë¥˜ ë°œìƒ: ' %}" + error.message);
        });
    }
</script>


</body>
</html>