{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
<!-- Favicon ì„¤ì • -->
<link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'GALATEA' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/custom.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<style>
/* typing-bubbles ìŠ¤íƒ€ì¼ */
.typing-bubbles {
  display: flex;
  gap: 4px;
  align-items: center;
  height: 20px;
}

.typing-bubbles span {
  width: 6px;
  height: 6px;
  background: #555;
  border-radius: 50%;
  display: block;
  animation: bounce 1s infinite ease-in-out;
}

.typing-bubbles span:nth-child(2) { animation-delay: 0.2s; }
.typing-bubbles span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
</style>

<body>
<!-- <header class="header">
    {% if not user.is_authenticated %}
        {% include "common/notLoginHeader.html" %}
    {% else %}
        {% include "common/loginHeader.html" %}
    {% endif %}
</header> -->



    <div class="app-container">
 

        <!-- Main Content -->
        <main class="main-content kakao-style" style="padding: 20px 10px;">
            <!-- ìˆ¨ê²¨ì§„ ì›¹ìº  (ë°±ê·¸ë¼ìš´ë“œ ìº¡ì²˜ìš©) -->
            <video id="webcam" autoplay playsinline style="display:none;"></video>

            <!-- Chat Messages -->
            <div class="chat-messages kakao-chat" id="message-area">
                <div class="message ai">
                    <div class="message-avatar">
                        {% if llm.llm_image %}
                            <img src="{{ llm.llm_image.url }}" alt="{{ llm.name }}" />
                        {% else %}
                            ğŸ‘ï¸
                        {% endif %}
                    </div>
                    <div class="message-wrapper">
                        <!-- <span class="message-name">{{ llm.name }}</span> -->
                        <div class="message-content">
                            {% if llm.first_sentence %}
                                <span class="message-description" style="opacity: 0.6; filter: blur(0.5px);">
                                    *{{ llm.description }}*
                                </span>
                                <br><br>
                                {{ llm.first_sentence }}
                            {% else %}
                                ì•ˆë…•í•˜ì„¸ìš”
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-row">
                    <button class="vision-toggle-btn" id="toggle-vision-btn" title="{% trans 'ë¹„ì „ ëª¨ë“œ ì‹œì‘/ì¤‘ì§€' %}">
                        <i class="fas fa-video" id="vision-icon"></i>
                    </button>
                    <input type="text" class="text-input" id="text-input"
                           placeholder="{% trans 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...' %}"
                           onkeydown="if(event.key === 'Enter'){ sendTextMessage(); }">
                    <button class="send-btn" onclick="sendTextMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>


                    <button class="record-btn" id="record-btn" onclick="toggleRecording()">
                        <i class="fas fa-microphone" id="record-icon"></i>
                    </button>
                    <div class="record-status" id="record-status" style="display: none;">
                    </div>
                </div>

                <div class="recognized-text" id="recognized-text"></div>
                <div class="vision-status" id="vision-result" style="display: none;"></div>

                <!-- Audio Player -->
                <div class="audio-player" id="audio-container" style="display: none;">
                    <audio id="tts-audio" controls style="display: none;"></audio>
                </div>
            </div>
        </main>
    </div>

<script>
    const LANGUAGE_CODE = "{{ LANGUAGE_CODE|default:'ko' }}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    const LLM_ID = {{ llm_id }};
    const LLM_IMAGE_URL = "{{ llm.llm_image.url }}";

    // Django ë²ˆì—­ ë¬¸ìì—´
    const messages = {
        recordingStart: "{% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”' %}",
        recordingInProgress: "{% trans 'ë…¹ìŒ ì¤‘... ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤' %}",
        micPermission: "{% trans 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' %}",
        recognizedText: "{% trans 'ì¸ì‹ëœ í…ìŠ¤íŠ¸: ' %}",
        audioUploadError: "{% trans 'ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' %}",
        errorOccurred: "{% trans 'ì˜¤ë¥˜ ë°œìƒ: ' %}",
        shareCopied: "{% trans 'ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!' %}"
    };
</script>

<script>
const baseUrl = window.location.pathname.replace(/\/(chat|vision)\/\d+\/?$/, '');

const video = document.getElementById('webcam');
const canvas = document.createElement('canvas');
const toggleBtn = document.getElementById('toggle-vision-btn');
const visionResult = document.getElementById('vision-result');
const ttsAudio = document.getElementById('tts-audio');
const messageArea = document.getElementById('message-area');

let streaming = false;
let intervalId = null;
let isVisionRunning = false;
let latestVisionResult = '';
let isProcessingVision = false;
let isPlayingAudio = false;

// ë…¹ìŒ ê´€ë ¨
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let stream;

// ì˜¤ë””ì˜¤ í´ë§ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
let audioCheckIntervals = new Map();

// ì›¹ìº  ì‹œì‘
async function startWebcam() {
    try {
        const streamMedia = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = streamMedia;
        streaming = true;
        visionResult.textContent = "{% trans 'ì›¹ìº ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤' %}";
        visionResult.style.display = 'block';
    } catch (err) {
        alert("{% trans 'ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨: ' %}" + err);
        visionResult.textContent = "{% trans 'ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨' %}";
        visionResult.style.display = 'block';
    }
}

// ì›¹ìº  ì¤‘ì§€
function stopWebcam() {
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    streaming = false;
}

// ì´ë¯¸ì§€ ë¶„ì„ ì„œë²„ ì „ì†¡ í•¨ìˆ˜
async function sendFrameToServer() {
    if (!streaming) return;
    if (isProcessingVision) return;
    if (isPlayingAudio) return;

    isProcessingVision = true;
    visionResult.textContent = "{% trans 'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...' %}";

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(async (blob) => {
        if (!blob) {
            isProcessingVision = false;
            return;
        }

        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');

        try {
            const response = await fetch(`${baseUrl}/vision_process/`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error("{% trans 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜' %}");
            const data = await response.json();
            visionResult.textContent = "{% trans 'ë¶„ì„ ì™„ë£Œ' %}";
            latestVisionResult = data.result;
        } catch (err) {
            console.error('Vision error:', err);
            visionResult.textContent = "{% trans 'ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ' %}";
        } finally {
            isProcessingVision = false;
        }
    }, 'image/jpeg');
}

// íƒ€ì´í•‘ íš¨ê³¼ í•¨ìˆ˜
function typewriterEffect(element, text, speed = 30) {
    element.textContent = '';
    let i = 0;

    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            const currentChar = text.charAt(i - 1);
            const delay = (currentChar === '.' || currentChar === '!' || currentChar === '?') ? speed * 3 : speed;
            setTimeout(type, delay);
        }
    }
    type();
}

// í…ìŠ¤íŠ¸ ì „ì†¡ í•¨ìˆ˜ (ì±„íŒ… ìŠ¤íƒ€ì¼)
function sendTextMessage() {
    const textInput = document.getElementById('text-input');
    const userText = textInput.value.trim();
    if (!userText) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    const userMessage = document.createElement("div");
    userMessage.className = "message user";
    userMessage.innerHTML = `
        <div class="message-wrapper">
            <div class="message-content">${userText}</div>
        </div>
    `;
    messageArea.appendChild(userMessage);
    textInput.value = "";

    // AI ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì„¤ì •
    const avatarImg = LLM_IMAGE_URL ?
        `<img src="${LLM_IMAGE_URL}" alt="AI" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
        'ğŸ‘ï¸';

    // AI typing bubble ì¶”ê°€
    const typingMessage = document.createElement("div");
    typingMessage.className = "message ai typing";
    typingMessage.innerHTML = `
        <div class="message-avatar">${avatarImg}</div>
        <div class="message-wrapper">
            <div class="message-content">
                <div class="typing-bubbles"><span></span><span></span><span></span></div>
            </div>
        </div>
    `;
    messageArea.appendChild(typingMessage);
    messageArea.scrollTop = messageArea.scrollHeight;

    // FormData ì¤€ë¹„
    const formData = new FormData();
    formData.append('text', userText);
    formData.append('vision', latestVisionResult);
    formData.append('llm_id', LLM_ID);

    // ì„œë²„ë¡œ ìš”ì²­ ì „ì†¡
    fetch(`${baseUrl}/generate_response/`, {
        method: 'POST',
        body: formData
    })
    .then(res => {
        if (!res.ok) return res.json().then(err => { throw new Error(err.error || "Unknown error"); });
        return res.json();
    })
    .then(data => {
        // typing bubble ì œê±°
        typingMessage.remove();

        // AI ì‘ë‹µ ë©”ì‹œì§€ ìƒì„±
        const aiMessage = document.createElement("div");
        aiMessage.className = "message ai";
        const messageId = 'ai-message-' + Date.now();
        aiMessage.innerHTML = `
            <div class="message-avatar">${avatarImg}</div>
            <div class="message-wrapper">
                <div class="message-content" id="${messageId}">
                    <div class="message-text"></div>
                </div>
            </div>
        `;
        messageArea.appendChild(aiMessage);
        messageArea.scrollTop = messageArea.scrollHeight;

        // íƒ€ì´í•‘ íš¨ê³¼ë¡œ AI ì‘ë‹µ í‘œì‹œ
        const responseDiv = aiMessage.querySelector('.message-text');
        typewriterEffect(responseDiv, data.ai_text, 25);

        // ì˜¤ë””ì˜¤ ìƒíƒœ í™•ì¸ ì‹œì‘
        if (data.conversation_id) {
            setTimeout(() => {
                checkAudioStatusForMessage(data.conversation_id, aiMessage);
            }, 1000);
        }

        // ìŠ¤í¬ë¡¤ ìœ ì§€
        const scrollInterval = setInterval(() => {
            messageArea.scrollTop = messageArea.scrollHeight;
        }, 50);

        setTimeout(() => {
            clearInterval(scrollInterval);
        }, data.ai_text.length * 25 + 500);
    })
    .catch(error => {
        if (typingMessage.parentNode) {
            typingMessage.remove();
        }

        const errorMessage = document.createElement("div");
        errorMessage.className = "message ai";
        errorMessage.innerHTML = `
            <div class="message-avatar">âš ï¸</div>
            <div class="message-content" style="color: #e74c3c;">
                ${messages.errorOccurred} ${error.message}
            </div>
        `;
        messageArea.appendChild(errorMessage);
        messageArea.scrollTop = messageArea.scrollHeight;

        console.error('Error:', error);
    });
}

// ì˜¤ë””ì˜¤ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
function checkAudioStatusForMessage(conversationId, messageElement) {
    const maxAttempts = 100;
    let attempts = 0;

    let statusElement = messageElement.querySelector('.audio-status');
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.className = 'audio-status';
        statusElement.style.cssText = 'font-size: 0.8em; color: #666; margin-top: 5px; font-style: italic;';
        messageElement.querySelector('.message-content').appendChild(statusElement);
    }
    statusElement.textContent = 'ğŸµ ìŒì„± ìƒì„± ì¤‘...';

    const checkInterval = setInterval(() => {
        attempts++;

        fetch(`${baseUrl}/check_audio_status/?conversation_id=${conversationId}`)
            .then(res => res.json())
            .then(data => {
                if (data.ready && data.audio_url) {
                    clearInterval(checkInterval);
                    audioCheckIntervals.delete(conversationId);

                    statusElement.textContent = 'ğŸ”Š ìŒì„± ì¬ìƒ';
                    statusElement.style.color = '#2ecc71';

                    playAudio(data.audio_url, statusElement);

                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    audioCheckIntervals.delete(conversationId);

                    statusElement.textContent = 'âš ï¸ ìŒì„± ìƒì„± ì‹œê°„ ì´ˆê³¼';
                    statusElement.style.color = '#e74c3c';
                }
            })
            .catch(error => {
                console.error('ì˜¤ë””ì˜¤ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);

                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    audioCheckIntervals.delete(conversationId);

                    statusElement.textContent = 'âš ï¸ ìŒì„± ìƒì„± ì‹¤íŒ¨';
                    statusElement.style.color = '#e74c3c';
                }
            });
    }, 500);

    audioCheckIntervals.set(conversationId, checkInterval);
}

// ì˜¤ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜
function playAudio(audioUrl, statusElement) {
    ttsAudio.src = audioUrl;
    document.getElementById('audio-container').style.display = 'block';

    ttsAudio.onplay = () => {
        if (statusElement) {
            statusElement.textContent = 'â–¶ï¸ ì¬ìƒ ì¤‘...';
            statusElement.style.color = '#3498db';
        }
        isPlayingAudio = true;
    };

    ttsAudio.onended = () => {
        if (statusElement) {
            statusElement.textContent = 'âœ“ ì¬ìƒ ì™„ë£Œ';
            statusElement.style.color = '#95a5a6';
            setTimeout(() => {
                if (statusElement) {
                    statusElement.style.display = 'none';
                }
            }, 3000);
        }
        isPlayingAudio = false;
    };

    ttsAudio.onerror = () => {
        if (statusElement) {
            statusElement.textContent = 'âš ï¸ ì¬ìƒ ì‹¤íŒ¨';
            statusElement.style.color = '#e74c3c';
        }
        isPlayingAudio = false;
    };

    ttsAudio.play().catch(error => {
        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
        if (statusElement) {
            statusElement.textContent = 'âš ï¸ ì¬ìƒ ì‹¤íŒ¨';
            statusElement.style.color = '#e74c3c';
        }
    });
}

// ë¹„ì „ ëª¨ë“œ í† ê¸€
toggleBtn.addEventListener('click', () => {
    if (!isVisionRunning) {
        startVisionMode();
    } else {
        stopVisionMode();
    }
});

// ë¹„ì „ ëª¨ë“œ ì‹œì‘
async function startVisionMode() {
    if (!streaming) await startWebcam();

    isVisionRunning = true;
    intervalId = setInterval(sendFrameToServer, 1500);

    document.getElementById('vision-icon').className = 'fas fa-stop';
    toggleBtn.classList.add('active');

    visionResult.textContent = "{% trans 'ë¹„ì „ ëª¨ë“œ ì‹¤í–‰ ì¤‘...' %}";
    visionResult.style.display = 'block';
}

// ë¹„ì „ ëª¨ë“œ ì¤‘ì§€
function stopVisionMode() {
    clearInterval(intervalId);
    stopWebcam();
    isVisionRunning = false;

    document.getElementById('vision-icon').className = 'fas fa-video';
    toggleBtn.classList.remove('active');

    visionResult.textContent = "{% trans 'ë¹„ì „ ëª¨ë“œ ì¤‘ì§€ë¨' %}";
}

// ë…¹ìŒ í† ê¸€
function toggleRecording() {
    const recordBtn = document.getElementById("record-btn");
    const recordIcon = document.getElementById("record-icon");
    const recordStatus = document.getElementById("record-status");

    if (!isRecording) {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then((s) => {
            stream = s;
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;

            recordIcon.className = "fas fa-stop";
            recordBtn.classList.add("recording");
            recordStatus.textContent = messages.recordingInProgress;

            mediaRecorder.addEventListener("dataavailable", (event) => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const formData = new FormData();
                formData.append("audio", audioBlob, "recorded.wav");

                fetch(`${baseUrl}/upload_audio/`, {
                    method: "POST",
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    const recognizedTextEl = document.getElementById("recognized-text");
                    recognizedTextEl.textContent = messages.recognizedText + data.text;
                    recognizedTextEl.style.display = "block";
                    setTimeout(() => { recognizedTextEl.style.display = "none"; }, 3000);

                    // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥ì°½ì— ë„£ê³  ì „ì†¡
                    document.getElementById('text-input').value = data.text;
                    sendTextMessage();
                })
                .catch((error) => {
                    alert(messages.audioUploadError + error.message);
                });
            });
        })
        .catch((err) => {
            alert(messages.micPermission);
            console.error(err);
        });
    } else {
        mediaRecorder.stop();
        isRecording = false;
        recordIcon.className = "fas fa-microphone";
        recordBtn.classList.remove("recording");
        recordStatus.textContent = messages.recordingStart;

        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }
}

// ì‚¬ì´ë“œë°” í† ê¸€
window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');
    sidebar.classList.toggle('active');
    hamburger.classList.toggle('active');
};

// ì‚¬ì´ë“œë°” ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');

    if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            sidebar.classList.remove('active');
            hamburger.classList.remove('active');
        }
    }
});

// í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ë¦¬ì…‹
window.addEventListener('resize', () => {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');

    if (window.innerWidth > 1024) {
        sidebar.classList.remove('active');
        hamburger.classList.remove('active');
    }
});

// ë§í¬ ë³µì‚¬ ê¸°ëŠ¥
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("share-btn")) {
        const link = e.target.getAttribute("data-link");
        navigator.clipboard.writeText(link).then(() => {
            alert(messages.shareCopied);
        });
    }
});

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ëª¨ë“  ì˜¤ë””ì˜¤ í™•ì¸ ì¸í„°ë²Œ ì •ë¦¬
window.addEventListener('beforeunload', () => {
    audioCheckIntervals.forEach((interval, conversationId) => {
        clearInterval(interval);
    });
    audioCheckIntervals.clear();
});

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    const textInput = document.getElementById('text-input');
    if (textInput) {
        textInput.focus();
    }

    console.log('Vision Mode UI initialized');
});
</script>
</body>
</html>
