{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'ë¹„ì „ ëª¨ë“œ' %}</title>
    <link rel="stylesheet" href="{% static 'css/customer_ai/vision.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>



<body>
    <!-- Header -->
<header class="header">
    {% if not user.is_authenticated %}
        {% include "common/notLoginHeader.html" %}
    {% else %}
        {% include "common/loginHeader.html" %}
    {% endif %}


</header>
    <div class="hamburger" style="margin-top: 50px;" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h3>ğŸ¯ {% trans 'ëª¨ë“œ ì„ íƒ' %}</h3>
            <div class="mode-options">
                <div class="mode-option ">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/chat/{{llm_id}}';" >
                    <label><i class="fas fa-comment"></i> TEXT MODE</label>
                </div>

                <div class="mode-option active">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/vision/{{llm_id}}';" checked>
                    <label><i class="fas fa-eye"></i> VISION MODE</label>
                </div>

                <div class="mode-option">
                    <input type="radio" name="mode" onclick="location.href='/customer_ai/novel/{{llm_id}}';">
                    <label><i class="fas fa-book"></i> NOVEL MODE</label>
                </div>

            </div>

    <button class="share-btn" data-link="{{ request.build_absolute_uri }}">
        {% trans 'ê³µìœ í•˜ê¸°' %}
    </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Section -->
            <div class="chat-header">
                <div class="ai-avatar">ğŸ‘ï¸</div>
                <h1 class="chat-title">{{ llm.name }} {% trans 'ë¹„ì „ ëŒ€í™”í•˜ê¸°' %}</h1>
            </div>
            <p class="chat-subtitle">{% trans 'ì¹´ë©”ë¼ë¡œ ì‹¤ì‹œê°„ ëŒ€í™”í•´ë³´ì„¸ìš”' %}</p>

            <!-- Video Container -->
            <div class="video-container">
                <!-- AI Image Section -->
                <div class="video-section">
                    <div class="section-title">
                        <i class="fas fa-robot"></i>
                        {% trans 'AI ìºë¦­í„°' %}
                    </div>
                    {% if llm.llm_image %}
                        <img src="{{ llm.llm_image.url }}" alt="{% trans 'AI ì´ë¯¸ì§€' %}" class="ai-image" />
                    {% else %}
                        <div class="no-image">{% trans 'ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤' %}</div>
                    {% endif %}
                </div>

                <!-- Webcam Section -->
                <div class="video-section">
                    <div class="section-title">
                        <i class="fas fa-video"></i>
                        {% trans 'ì‹¤ì‹œê°„ ì¹´ë©”ë¼' %}
                    </div>
                    <video id="webcam" autoplay playsinline></video>
                </div>
            </div>
            <!-- Audio Section -->
            <div class="audio-section">
                <div class="audio-controls">
                    <button class="record-btn" id="record-btn" onclick="toggleRecording()">
                        <i class="fas fa-microphone" id="record-icon"></i>
                    </button>
                    <div class="record-status" id="record-status">
                        {% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”' %}
                    </div>
                </div>
                
                <div class="recognized-text" id="recognized-text-display"></div>
                
                <!-- Audio Player -->
                <div class="audio-player" id="audio-container" style="display: none;">
                    <audio id="tts-audio" controls></audio>
                </div>
            </div>
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-row">
                    <button class="vision-toggle" id="toggle-vision-btn">
                        <i class="fas fa-play"></i>
                        {% trans 'ë¹„ì „ ëª¨ë“œ ì‹œì‘' %}
                    </button>
                    <div class="vision-status" id="vision-result">
                        {% trans 'ë¹„ì „ ëª¨ë“œ ì¤€ë¹„ ì¤‘...' %}
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-microphone"></i>
                        {% trans 'ìŒì„± ì¸ì‹ ê²°ê³¼' %}
                    </div>
                    <div class="result-content" id="recognized-text">
                        {% trans 'ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘...' %}
                    </div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-robot"></i>
                        {% trans 'AI ì‘ë‹µ' %}
                    </div>
                    <div class="result-content" id="response">
                        {% trans 'AI ì‘ë‹µ ëŒ€ê¸° ì¤‘...' %}
                    </div>
                </div>
            </div>


        </main>
    </div>
    <script src="{% static 'js/customer_ai/custom.js' }"></script>

<script>
        const baseUrl = window.location.pathname.replace(/\/(chat|vision)\/\d+\/?$/, '');

const video = document.getElementById('webcam');
const canvas = document.createElement('canvas');
const toggleBtn = document.getElementById('toggle-vision-btn');
const visionResult = document.getElementById('vision-result');
const ttsAudio = document.getElementById('tts-audio');
const responseDiv = document.getElementById('response');
const recognizedText = document.getElementById('recognized-text');
const recognizedTextDisplay = document.getElementById('recognized-text-display');

let streaming = false;
let intervalId = null;
let isVisionRunning = false;
let latestVisionResult = '';

let isProcessingVision = false;
let isPlayingAudio = false;


// ì›¹ìº  ì‹œì‘
async function startWebcam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        video.classList.add('active');
        streaming = true;
        visionResult.textContent = "{% trans 'ì›¹ìº ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤' %}";
        visionResult.className = "vision-status active";
    } catch (err) {
        alert("{% trans 'ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨: ' %}" + err);
        visionResult.textContent = "{% trans 'ì›¹ìº  ì ‘ê·¼ ì‹¤íŒ¨' %}";
        visionResult.className = "vision-status";
    }
}

// ì›¹ìº  ì¤‘ì§€
function stopWebcam() {
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
    video.classList.remove('active');
    streaming = false;
}

// ì´ë¯¸ì§€ ë¶„ì„ ì„œë²„ ì „ì†¡ í•¨ìˆ˜
async function sendFrameToServer() {
    if (!streaming) return;
    if (isProcessingVision) return;
    if (isPlayingAudio) return;

    isProcessingVision = true;
    visionResult.textContent = "{% trans 'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...' %}";
    visionResult.className = "vision-status processing";

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    canvas.toBlob(async (blob) => {
        if (!blob) {
            isProcessingVision = false;
            return;
        }

        const formData = new FormData();
        formData.append('image', blob, 'frame.jpg');

        try {
            const response = await fetch(`${baseUrl}/vision_process/`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error("{% trans 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜' %}");
            const data = await response.json();
            visionResult.textContent = "{% trans 'ë¶„ì„ ì™„ë£Œ: ' %}" + data.result;
            visionResult.className = "vision-status active";
            latestVisionResult = data.result;
        } catch (err) {
            console.error('Vision error:', err);
            visionResult.textContent = "{% trans 'ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ' %}";
            visionResult.className = "vision-status";
        } finally {
            isProcessingVision = false;
        }
    }, 'image/jpeg');
}

// GPT ì‘ë‹µ ìš”ì²­
async function sendText(text) {
    if (!text || !text.trim()) return;
    const currentLlmId = "{{ llm_id }}";
    
    isPlayingAudio = true;
    responseDiv.textContent = "{% trans 'AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘...' %}";

    const formData = new FormData();
    formData.append('text', text);
    formData.append('vision', latestVisionResult);
    formData.append('llm_id', currentLlmId);

    try {
        const res = await fetch(`${baseUrl}/generate_response/`, {
            method: 'POST',
            body: formData,
        });
        if (!res.ok) throw new Error('ì‘ë‹µ ì‹¤íŒ¨');
        const data = await res.json();

        responseDiv.textContent = data.ai_text;
        if (data.audio_url) {
            ttsAudio.src = data.audio_url + '?t=' + new Date().getTime();
            document.getElementById('audio-container').style.display = 'block';
            await ttsAudio.play();
        }
    } catch (err) {
        responseDiv.textContent = 'ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
        console.error(err);
    }
}

// ì˜¤ë””ì˜¤ ì¬ìƒ ì¢…ë£Œ ì‹œì  í”Œë˜ê·¸ í•´ì œ
ttsAudio.addEventListener('ended', () => {
    isPlayingAudio = false;
});

// ë¹„ì „ ëª¨ë“œ í† ê¸€
toggleBtn.addEventListener('click', () => {
    if (!isVisionRunning) {
        startVisionMode();
    } else {
        stopVisionMode();
    }
});

// ë¹„ì „ ëª¨ë“œ ì‹œì‘
async function startVisionMode() {
    if (!streaming) await startWebcam();
    
    isVisionRunning = true;
    intervalId = setInterval(sendFrameToServer, 1500);
    
    toggleBtn.innerHTML = '<i class="fas fa-stop"></i> {% trans "ë¹„ì „ ëª¨ë“œ ì¤‘ì§€" %}';
    toggleBtn.classList.add('active');
    
    visionResult.textContent = "{% trans 'ë¹„ì „ ëª¨ë“œ ì‹¤í–‰ ì¤‘...' %}";
    visionResult.className = "vision-status processing";
}

// ë¹„ì „ ëª¨ë“œ ì¤‘ì§€
function stopVisionMode() {
    clearInterval(intervalId);
    stopWebcam();
    isVisionRunning = false;
    
    toggleBtn.innerHTML = '<i class="fas fa-play"></i> {% trans "ë¹„ì „ ëª¨ë“œ ì‹œì‘" %}';
    toggleBtn.classList.remove('active');
    
    visionResult.textContent = "{% trans 'ë¹„ì „ ëª¨ë“œ ì¤‘ì§€ë¨' %}";
    visionResult.className = "vision-status";
}

// ë…¹ìŒ ê´€ë ¨
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let stream;

function toggleRecording() {
    const recordBtn = document.getElementById("record-btn");
    const recordIcon = document.getElementById("record-icon");
    const recordStatus = document.getElementById("record-status");

    if (!isRecording) {
        navigator.mediaDevices
            .getUserMedia({ audio: true })
            .then((s) => {
                stream = s;
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;

                recordIcon.className = "fas fa-stop";
                recordBtn.classList.add("recording");
                recordStatus.textContent = "{% trans 'ë…¹ìŒ ì¤‘... ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¢…ë£Œë©ë‹ˆë‹¤' %}";

                mediaRecorder.addEventListener("dataavailable", (event) => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                    const formData = new FormData();
                    formData.append("audio", audioBlob, "recorded.wav");

                    fetch(`${baseUrl}/upload_audio/`, {
                        method: "POST",
                        body: formData,
                    })
                    .then((res) => res.json())
                    .then((data) => {
                        recognizedText.textContent = "{% trans 'ì¸ì‹ëœ í…ìŠ¤íŠ¸: ' %}" + data.text;
                        recognizedTextDisplay.textContent = "{% trans 'ì¸ì‹ëœ í…ìŠ¤íŠ¸: ' %}" + data.text;
                        recognizedTextDisplay.style.display = "block";
                        
                        setTimeout(() => {
                            recognizedTextDisplay.style.display = "none";
                        }, 3000);
                        
                        sendText(data.text);
                    })
                    .catch((error) => {
                        alert("{% trans 'ì˜¤ë””ì˜¤ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' %}" + error.message);
                    });
                });
            })
            .catch((err) => {
                alert("{% trans 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' %}");
                console.error(err);
            });
    } else {
        mediaRecorder.stop();
        isRecording = false;
        recordIcon.className = "fas fa-microphone";
        recordBtn.classList.remove("recording");
        recordStatus.textContent = "{% trans 'ë…¹ìŒì„ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”' %}";
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    visionResult.textContent = "{% trans 'ë¹„ì „ ëª¨ë“œ ì¤€ë¹„ ì¤‘...' %}";
    recognizedText.textContent = "{% trans 'ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘...' %}";
    responseDiv.textContent = "{% trans 'AI ì‘ë‹µ ëŒ€ê¸° ì¤‘...' %}";
});

// Sidebar toggle function
window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');
    sidebar.classList.toggle('active');
    hamburger.classList.toggle('active');
};

// Sidebar outside click close
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');

    if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
        if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            sidebar.classList.remove('active');
            hamburger.classList.remove('active');
        }
    }
});

// Resize event to reset sidebar
window.addEventListener('resize', () => {
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.querySelector('.hamburger');

    if (window.innerWidth > 1024) {
        sidebar.classList.remove('active');
        hamburger.classList.remove('active');
    }
});

</script>
</body>
</html>