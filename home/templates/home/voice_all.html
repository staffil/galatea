{% load static %} 
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% trans "GALATEA - Chat with Celebrities" %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/home/voice_all.css' %}">
    <script src="{% static 'js/home/main.js' %}"></script>
</head>


<style>
    .refresh-btn {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.refresh-btn:hover {
    background-color: #45a049;
}

</style>

<body >

        <!-- 헤더 -->
    <header>
        {% if not user.is_authenticated %}
            {% include "common/notLoginHeader.html" %}
        {% else %}
            {% include "common/loginHeader.html" %}
        {% endif %}
    </header>
        <!-- celebrity voice 목록 -->
        <div class="cv-main-content">
            <h2 class="cv-section-title">{% trans '이거 한번 사용해 보세요!' %}</h2>
            <p>{% trans '🎶가 있는 목소리는 노래가 가능힙니다.' %}</p>
            <div class="cv-container">


                <div class="cv-scroll">
{% for voice in voice_list|slice:":30" %}
                        <div class="voice-wrapper">
                            <div class="cv-header">
                                <div class="voice-character" onclick="toggleAudio(this)" data-voice-id="{{ voice.id }}">
                                    {% if voice.celebrity_voice_image %}
                                        <img src="{{ voice.celebrity_voice_image.url }}" alt="" loading="lazy">
                                    {% else %}
                                        <img src="{% static 'images/default_voice.png' %}" alt="" loading="lazy">
                                    {% endif %}
                                    <div class="cv-play-overlay"><div class="cv-play-icon"></div></div>
                                </div>
                                <div class="cv-info">
                                    <p>{{ voice.name }}</p>
                                    <input type="hidden" value="{{ voice.celebrity_voice_id }}">
                                    <p>{{ voice.voice_name }}</p>
                                </div>
                            </div>
                            <div class="voice-progress" onclick="seekAudio(event, this)">
                                <div class="cv-progress-bar"></div>
                            </div>
                            <!-- <button class="copy-id-btn" onclick="copyVoiceId(this)" title="Voice ID 복사">복사</button> -->
                             <button class="copy-id-btn" onclick="saveVoice({{ voice.id }})" title="Voice ID 복사">{% trans '저장하기' %}</button>

                            {% if voice.sample_url %}
                                <audio class="voice-audio" controls>
                                    <source src="{{ voice.sample_url.url }}" type="audio/mpeg">
                                </audio>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
<!-- 새로고침 버튼 -->
<div style="text-align:center; margin: 20px 0;">
    <button onclick="refreshPage()" class="refresh-btn">{% trans '새로고침' %}</button>
</div>

        </div>

    <script>
function refreshPage() {
    window.location.reload();  // 현재 페이지 새로고침
}
        
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // 쿠키 이름 확인
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

        // 목소리 저장하기
function saveVoice(celebrityId){
    fetch("{% url 'home:save_voice' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken') // CSRF 처리
        },
        body: JSON.stringify({ "celebrity_id": celebrityId })
    })
    .then(res => res.json())
    .then(data=>{
        if (data.status === "ok") {
            alert("보이스가 저장되었습니다!");
        } else {
            alert(data.error);
        }
    })
    .catch(error => console.error("Error:", error));
}

    </script>
</body>
</html>