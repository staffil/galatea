"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnimateRallyPresence=AnimateRallyPresence;const jsx_runtime_1=require("react/jsx-runtime"),react_1=require("react"),useForceRerender_js_1=require("../hooks/utils/useForceRerender.js"),useIsMounted_js_1=require("../hooks/utils/useIsMounted.js"),PresenceChild_js_1=require("./PresenceChild.js"),getComponentKey=n=>n.key||"",getOnlyElements=n=>{const l=[];return react_1.Children.forEach(n,t=>{(0,react_1.isValidElement)(t)&&l.push(t)}),l},updateChildLookup=(n,l)=>{n.forEach(t=>{const d=getComponentKey(t);l.set(d,t)})};function AnimateRallyPresence(n){const l=(0,useIsMounted_js_1.useIsMounted)(),t=(0,react_1.useRef)(!0),{forceRerender:d}=(0,useForceRerender_js_1.useForceRerender)(),c=(0,react_1.useMemo)(()=>getOnlyElements(n.children),[n.children]);let r=c;const u=(0,react_1.useRef)(r),i=(0,react_1.useRef)(new Set).current,o=(0,react_1.useRef)(new Map).current;if((0,react_1.useLayoutEffect)(()=>{t.current=!1,updateChildLookup(c,o),u.current=r},[o,r,c]),(0,react_1.useEffect)(()=>()=>{t.current=!0,o.clear(),i.clear()},[]),t.current)return(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:r.map(e=>(0,jsx_runtime_1.jsx)(PresenceChild_js_1.PresenceChild,{present:!0,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:e},getComponentKey(e)))});r=[...r];const f=u.current.map(getComponentKey),a=c.map(getComponentKey);for(let e=0;e<f.length;e+=1){const s=f[e];a.indexOf(s)===-1&&i.add(s)}return i.forEach(e=>{if(a.indexOf(e)!==-1)return;const s=o.get(e);if(!s)return;const m=f.indexOf(e),h=()=>{o.delete(e),i.delete(e);const x=u.current.findIndex(C=>C.key===e);if(u.current.splice(x,1),n.preserveUntilCompleteAll!==!0&&d(),i.size===0){if(u.current=c,l===!1)return;d(),n.onExitEnd!==void 0&&n.onExitEnd()}};r.splice(m,0,(0,jsx_runtime_1.jsx)(PresenceChild_js_1.PresenceChild,{present:!1,onExitEnd:h,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:s},getComponentKey(s)))}),r=r.map(e=>{const s=e.key;return i.has(s)?e:(0,jsx_runtime_1.jsx)(PresenceChild_js_1.PresenceChild,{present:!0,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:e},getComponentKey(e))}),(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:r})}
