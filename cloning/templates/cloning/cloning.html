{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Voice Cloning</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/makeVoice/makeVoice.css' %}" />
</head>
<body>
    <header>
        {% if not user.is_authenticated %}
        {% include "common/notLoginHeader.html" %}
        {% else %}
        {% include "common/loginHeader.html" %}
        {% endif %}
    </header>

    <main class="container">
        <div class="main-card">
            <h1>ğŸ¤ AI ëª©ì†Œë¦¬ í´ë¡œë‹</h1>

            <div class="form-group">
                <label for="voiceName">ğŸ·ï¸ ëª©ì†Œë¦¬ ì´ë¦„</label>
                <input type="text" id="voiceName" placeholder="ë‚˜ë§Œì˜ ëª©ì†Œë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>

            <div class="form-group">
                <button id="recordBtn">ğŸ”´ ë…¹ìŒ ì‹œì‘</button>
                <button id="stopBtn" disabled>â–  ë…¹ìŒ ì¤‘ì§€</button>
            </div>

            <div class="form-group">
                <audio id="audioPlayback" controls></audio>
            </div>

            <div class="form-group">
                <label for="sampleText">ğŸ“ ìƒ˜í”Œ í…ìŠ¤íŠ¸</label>
                <textarea id="sampleText" rows="5" placeholder="ì´ í…ìŠ¤íŠ¸ë¡œ í´ë¡œë‹ëœ ëª©ì†Œë¦¬ë¥¼ ìƒ˜í”Œ ì¬ìƒí•©ë‹ˆë‹¤. ìµœì†Œ 130ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
            </div>

            <div class="button-group">
                <button id="generateSampleBtn" disabled>âœ¨ ìƒ˜í”Œ ìƒì„±í•˜ê¸°</button>
                <button id="retryBtn" disabled>ğŸ”„ ë‹¤ì‹œ ë§Œë“¤ê¸°</button>
                <button id="saveBtn" disabled>ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            </div>

            <div id="message" style="margin-top: 1rem; color: red;"></div>
        </div>
    </main>

<script>
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const audioPlayback = document.getElementById('audioPlayback');
const generateSampleBtn = document.getElementById('generateSampleBtn');
const retryBtn = document.getElementById('retryBtn');
const saveBtn = document.getElementById('saveBtn');
const voiceNameInput = document.getElementById('voiceName');
const sampleTextInput = document.getElementById('sampleText');
const messageDiv = document.getElementById('message');

let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;
let savedVoiceId = null;

function showMessage(text, color = 'red') {
    messageDiv.style.color = color;
    messageDiv.textContent = text;
}

recordBtn.onclick = async () => {
    showMessage('');
    audioChunks = [];
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.ondataavailable = e => {
            audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioPlayback.src = URL.createObjectURL(recordedBlob);
            generateSampleBtn.disabled = false;
            retryBtn.disabled = false;
            saveBtn.disabled = true;
            savedVoiceId = null;
        };
    } catch(err) {
        showMessage('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    }
};

stopBtn.onclick = () => {
    mediaRecorder.stop();
    recordBtn.disabled = false;
    stopBtn.disabled = true;
};

generateSampleBtn.onclick = async () => {
    showMessage('');
    const voiceName = voiceNameInput.value.trim();
    const sampleText = sampleTextInput.value.trim();

    if (!voiceName) {
        alert('ëª©ì†Œë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!sampleText || sampleText.length < 130) {
        alert('ìƒ˜í”Œ í…ìŠ¤íŠ¸ë¥¼ 130ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    if (!recordedBlob) {
        alert('ë…¹ìŒëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    generateSampleBtn.disabled = true;
    showMessage('ìƒ˜í”Œ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...', 'blue');

    const formData = new FormData();
    formData.append('voice_name', voiceName);
    formData.append('sample_text', sampleText);
    formData.append('audio', recordedBlob, 'recorded.webm');

    try {
        const res = await fetch("{% url 'cloning:voice_cloning_sample' %}", {
            method: 'POST',
            body: formData,
            credentials: 'include',
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
            },
        });
        const data = await res.json();

        if (data.status === 'success') {
            audioPlayback.src = data.sample_url;
            savedVoiceId = data.voice_id;
            saveBtn.disabled = false;
            showMessage('ìƒ˜í”Œ ìƒì„± ì™„ë£Œ! ëª©ì†Œë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'green');
        } else {
            showMessage('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (e) {
        showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        generateSampleBtn.disabled = false;
    }
};

retryBtn.onclick = () => {
    recordedBlob = null;
    savedVoiceId = null;
    audioPlayback.src = '';
    sampleTextInput.value = '';
    voiceNameInput.value = '';
    generateSampleBtn.disabled = true;
    retryBtn.disabled = true;
    saveBtn.disabled = true;
    showMessage('');
};

saveBtn.onclick = async () => {
    showMessage('');
    if (!savedVoiceId) {
        alert('ì €ì¥í•  ëª©ì†Œë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const voiceName = voiceNameInput.value.trim();
    if (!voiceName) {
        alert('ëª©ì†Œë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    try {
        const res = await fetch("{% url 'cloning:voice_cloning_save' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'include',
            body: JSON.stringify({
                voice_id: savedVoiceId,
                voice_name: voiceName,
            }),
        });
        const data = await res.json();
        if (data.status === 'success') {
            alert('ëª©ì†Œë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            window.location.href = '/mypage/my_voice/';
        } else {
            showMessage('ì €ì¥ ì˜¤ë¥˜: ' + data.error);
        }
    } catch (e) {
        showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
};

// CSRF token ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (Django ê¸°ë³¸ ë°©ì‹)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(c.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>
