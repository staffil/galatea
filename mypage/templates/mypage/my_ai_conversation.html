{% load static %} 
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="background-color: #3b0d69;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'ë§ˆì´í˜ì´ì§€' %} - GALATEA</title>

    <link rel="stylesheet" href="{% static 'css/mypage/my_ai_models.css' %}?v={{ STATIC_VERSION }}">
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/mypage/my_ai_conversation.css' %}">
        <!-- Open Graph (SNS ê³µìœ ìš©) -->
    <meta property="og:title" content="GALATEA AI - ìŒì„± ëŒ€í™”í˜• ì±—ë´‡" />
    <meta property="og:description" content="ìì—°ìŠ¤ëŸ¬ìš´ ìŒì„± ëŒ€í™”í˜• AI ì±—ë´‡. ê³ ê°ê³¼ ì‚¬ëŒì²˜ëŸ¼ ëŒ€í™”í•˜ë©° ìƒë‹´ê³¼ ì•ˆë‚´ë¥¼ ì œê³µí•©ë‹ˆë‹¤." />
    <meta property="og:image" content="https://galatea.website/static/img/intro2.png">
    <meta property="og:url" content="https://galatea.website" />
    <meta property="og:type" content="website" />

    <!-- Meta Description (ê²€ìƒ‰ ê²°ê³¼ìš©) -->
    <meta name="description" content="ë¬¸ìë§Œ ì…ë ¥í•˜ëŠ” ì±—ë´‡ì€ ì´ì œ ê·¸ë§Œ! GALATEA AIëŠ” ìŒì„± ê¸°ë°˜ ëŒ€í™”í˜• AIë¡œ, ì‹¤ì œ ì‚¬ëŒì²˜ëŸ¼ ëŒ€í™” ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤. GALATEA AIëŠ” ë‹¨ìˆœí•œ ì±—ë´‡ì´ ì•„ë‹™ë‹ˆë‹¤. ìŒì„±ìœ¼ë¡œ ì‚¬ëŒì²˜ëŸ¼ ëŒ€í™”í•˜ë©°, ìì—°ìŠ¤ëŸ¬ìš´ ìƒë‹´Â·ì•ˆë‚´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì§€ê¸ˆ ë¬´ë£Œ ì²´í—˜ìœ¼ë¡œ ì§ì ‘ ê²½í—˜í•´ë³´ì„¸ìš”. ">

    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "GALATEA AI",
  "url": "https://www.galatea.website",
  "logo": "https://www.galatea.website/static/img/logo.png"
}
</script>

    <style>

    </style>
</head>
<body>

      
<header>
    {% if not user.is_authenticated %}
        {% include "common/notLoginHeader.html" %}
    {% else %}
        {% include "common/loginHeader.html" %}
    {% endif %}
</header>
    <!-- ë°°ê²½ ì›í˜• íš¨ê³¼ -->
    <div class="circle-bg circle-1"></div>
    <div class="circle-bg circle-2"></div>
    <div class="circle-bg circle-3"></div>
    <div class="circle-bg circle-4"></div>
    <div class="circle-bg circle-5"></div>

    <!-- í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    {% include "common/sidebar.html" %}

    <div class="main-content">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header fade-in">
            <h1 class="page-title">{% trans 'AI ëŒ€í™” ë‚´ì—­' %}</h1>
            <p class="page-subtitle">{% trans 'ë‚˜ì˜ AIì™€ ë‚˜ëˆˆ ëª¨ë“  ëŒ€í™”ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”' %}</p>
        </div>

        <!-- AI ì„ íƒ ì„¹ì…˜ -->
        <div class="ai-selector-section fade-in">
            <h2 class="ai-selector-title">{% trans 'AI ì„ íƒ' %}</h2>
            <div class="ai-grid" id="aiGrid">
                <!-- AI ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ëŒ€í™” ë‚´ì—­ ì„¹ì…˜ -->
        <div class="conversations-section fade-in">
            <div class="conversations-header">
                <h2 class="conversations-title">{% trans 'ëŒ€í™” ë‚´ì—­' %}</h2>
                <div class="selected-ai-info" id="selectedAiInfo" style="display: none;">
                    <span class="selected-ai-name" id="selectedAiName"></span>
                    <span class="conversation-stats" id="conversationStats"></span>
                </div>
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ’¬</div>
                    <h3 class="empty-title">{% trans 'AIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”' %}</h3>
                    <p class="empty-description">{% trans 'ìœ„ì—ì„œ AIë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ AIì™€ì˜ ëŒ€í™” ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' %}</p>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/sidebar.js' %}"></script>
    <script>
        // Djangoì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ë³€í™˜
        const conversationsData = [
            {% for conversation in llm_list %}
            {
                id: {{ conversation.id }},
                llmName: "{{ conversation.llm.name|escapejs }}",
                llmId: {{ conversation.llm.id }},
                userMessage: "{{ conversation.user_message|escapejs }}",
                llmResponse: "{{ conversation.llm_response|escapejs }}",
                responseAudio: "{% if conversation.response_audio %}{{ conversation.response_audio|escapejs }}{% else %}''{% endif %}",
                createdAt: "{{ conversation.created_at|date:'c' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        let selectedAiId = null;
        let aiList = {};

        // ë°ì´í„° ì´ˆê¸°í™”
        function initializeData() {
            // AIë³„ë¡œ ëŒ€í™” ë°ì´í„° ê·¸ë£¹í™”
            conversationsData.forEach(conversation => {
                const aiId = conversation.llmId;
                const aiName = conversation.llmName;
                
                if (!aiList[aiId]) {
                    aiList[aiId] = {
                        name: aiName,
                        conversations: []
                    };
                }
                
                aiList[aiId].conversations.push(conversation);
            });

            // ê° AIì˜ ëŒ€í™”ë¥¼ ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬
            Object.keys(aiList).forEach(aiId => {
                aiList[aiId].conversations.sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
            });
        }

        // AI ê·¸ë¦¬ë“œ ë Œë”ë§
        function renderAiGrid() {
            const aiGrid = document.getElementById('aiGrid');
            const aiIds = Object.keys(aiList);
            
            if (aiIds.length === 0) {
                aiGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¤–</div>
                        <h3 class="empty-title">{% trans 'ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤' %}</h3>
                        <p class="empty-description">{% trans 'AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!' %}</p>
                    </div>
                `;
                return;
            }

            aiGrid.innerHTML = aiIds.map(aiId => {
                const ai = aiList[aiId];
                const conversationCount = ai.conversations.length;
                
                return `
                    <div class="ai-card" data-ai-id="${aiId}" onclick="selectAi(${aiId})">
                        <div class="ai-icon">ğŸ¤–</div>
                        <div class="ai-name">${ai.name}</div>
                        <div class="ai-count">${conversationCount}{% trans 'ê°œì˜ ëŒ€í™”' %}</div>
                    </div>
                `;
            }).join('');
        }

        // AI ì„ íƒ
        function selectAi(aiId) {
            selectedAiId = aiId;
            
            // ì„ íƒëœ AI ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('.ai-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-ai-id="${aiId}"]`).classList.add('selected');
            
            // ì„ íƒëœ AI ì •ë³´ í‘œì‹œ
            const ai = aiList[aiId];
            const selectedAiInfo = document.getElementById('selectedAiInfo');
            const selectedAiName = document.getElementById('selectedAiName');
            const conversationStats = document.getElementById('conversationStats');
            
            selectedAiName.textContent = ai.name;
            conversationStats.textContent = `{% trans 'ì´' %} ${ai.conversations.length}{% trans 'ê°œì˜ ëŒ€í™”' %}`;
            selectedAiInfo.style.display = 'flex';
            
            // ëŒ€í™” ë‚´ì—­ ë Œë”ë§
            renderConversations(aiId);
        }

        // ëŒ€í™” ë‚´ì—­ ë Œë”ë§
        function renderConversations(aiId) {
            const conversationsList = document.getElementById('conversationsList');
            const ai = aiList[aiId];
            
            if (!ai || ai.conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h3 class="empty-title">{% trans 'ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤' %}</h3>
                        <p class="empty-description">{% trans 'ì„ íƒí•œ AIì™€ ì•„ì§ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' %}</p>
                    </div>
                `;
                return;
            }

            // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
            const conversationsByDate = {};
            ai.conversations.forEach(conversation => {
                const date = new Date(conversation.createdAt).toLocaleDateString('ko-KR');
                if (!conversationsByDate[date]) {
                    conversationsByDate[date] = [];
                }
                conversationsByDate[date].push(conversation);
            });

            const conversationsHtml = Object.keys(conversationsByDate).map(date => {
                const dayConversations = conversationsByDate[date];
                
                return dayConversations.map(conversation => `
                    <div class="conversation-item">
                        <div class="conversation-header">
                            <span class="conversation-date">${date}</span>
                            <span class="conversation-time">${formatTime(conversation.createdAt)}</span>
                        </div>
                        <div class="message-pair">
                            <div class="user-message">
                                <div class="message-text">${conversation.userMessage}</div>
                            </div>
                            <div class="ai-message">
                                <div class="message-text">${conversation.llmResponse}</div>
                            </div>
                        <div class="ai-message">
                            ${conversation.responseAudio ? `
                                <audio controls>
                                    <source src="${conversation.responseAudio}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            ` : ''}
                        </div>
                        </div>
                    </div>
                `).join('');
            }).join('');

            conversationsList.innerHTML = conversationsHtml;
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }


        // ê²€ìƒ‰ ê¸°ëŠ¥ (ì¶”í›„ í™•ì¥ ê°€ëŠ¥)
        function searchConversations(query) {
            if (!selectedAiId) return;
            
            const ai = aiList[selectedAiId];
            const filteredConversations = ai.conversations.filter(conversation => 
                conversation.userMessage.toLowerCase().includes(query.toLowerCase()) ||
                conversation.llmResponse.toLowerCase().includes(query.toLowerCase()) ||
                conversation.responseAudio.toLowerCase().includes(query.toLowerCase())
            );
            
            // í•„í„°ë§ëœ ê²°ê³¼ë¡œ ì„ì‹œ AI ê°ì²´ ìƒì„±
            const tempAi = { ...ai, conversations: filteredConversations };
            
            // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§ (í˜„ì¬ëŠ” êµ¬í˜„ë˜ì§€ ì•ŠìŒ)
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            renderAiGrid();
            
            // ì²« ë²ˆì§¸ AI ìë™ ì„ íƒ (ì˜µì…˜)
            const firstAiId = Object.keys(aiList)[0];
            if (firstAiId) {
                selectAi(firstAiId);
            }
        });

        // ìŠ¬ë¼ì´ë” ì„¤ì • (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        function setupSliderListeners() {
            const sliders = [
                { id: "stabilitySlider", valueId: "stabilityValue", inputId: "stabilityInput" },
                { id: "speedSlider", valueId: "speedValue", inputId: "speedInput" },
                { id: "styleSlider", valueId: "styleValue", inputId: "styleInput" },
                { id: "temperatureSlider", valueId: "temperatureValue", inputId: "temperatureInput" }
            ];

            sliders.forEach(slider => {
                const element = document.getElementById(slider.id);
                if (element) {
                    element.oninput = function() {
                        const valueElement = document.getElementById(slider.valueId);
                        const inputElement = document.getElementById(slider.inputId);
                        
                        if (valueElement) valueElement.textContent = this.value;
                        if (inputElement) inputElement.value = this.value;
                    };
                }
            });
        }

        window.onload = function() {
            setupSliderListeners();
        };

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            // ESCë¡œ ì‚¬ì´ë“œë°” ë‹«ê¸°
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });

        // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
        function observeElements() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                    }
                });
            });

            document.querySelectorAll('.conversation-item').forEach(item => {
                observer.observe(item);
            });
        }

        // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>