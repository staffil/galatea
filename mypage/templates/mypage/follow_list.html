{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="background-color: #3b0d69;">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% trans "마이페이지 - GALATEA" %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/mypage/follow_list.css' %}">

</head>
<body>
    <!-- 배경 원형 효과 -->
    <div class="circle-bg circle-1"></div>
    <div class="circle-bg circle-2"></div>
    <div class="circle-bg circle-3"></div>
    <div class="circle-bg circle-4"></div>
    <div class="circle-bg circle-5"></div>

    <!-- 햄버거 메뉴 버튼 -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- 사이드바 오버레이 -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    {% include "common/sidebar.html" %}

{% load static %}
{% load i18n %}

<div class="main-content">

   <!-- 팔로워 섹션 -->
    <div class="section">
        <h2 class="section-title">
            {% trans "팔로워 목록" %}
            <span class="count-badge">{{ follower_list|length }}</span>
        </h2>

        {% if follower_list %}
            {% for follow in follower_list %}
                {% with target_user=follow.follower %}
                <div class="user-item" onclick="openUserModal({{ target_user.id }})" style="cursor: pointer;">
                    <div class="user-avatar">
                        {% if target_user.user_image %}
                            <img src="{{ target_user.user_image.url }}" alt="{{ target_user.username }}">
                        {% else %}
                            <img src="{% static 'images/default_user.png' %}" alt="{{ target_user.username }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3 class="username">{{ target_user.username }}</h3>
                    </div>

                </div>
                {% endwith %}
                
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">👥</div>
                <div class="empty-state-text">{% trans "아직 팔로워가 없습니다" %}</div>
                <div class="empty-state-subtext">{% trans "다른 사용자들과 소통해보세요!" %}</div>
            </div>
        {% endif %}
    </div>

    <!-- 팔로잉 섹션 -->
    <div class="section">
        <h2 class="section-title">
            {% trans "팔로잉 목록" %}
            <span class="count-badge">{{ following_list|length }}</span>
        </h2>

        {% if following_list %}
            {% for follow in following_list %}
                {% with target_user=follow.following %}
                <div class="user-item" onclick="openUserModal({{ target_user.id }})" style="cursor: pointer;">
                    <div class="user-avatar" >
                        {% if target_user.user_image %}
                            <img src="{{ target_user.user_image.url }}" alt="{{ target_user.username }}">
                        {% else %}
                            <img src="{% static 'images/default_user.png' %}" alt="{{ target_user.username }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3 class="username">{{ target_user.username }}</h3>
                    </div>

                </div>
                {% endwith %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">➕</div>
                <div class="empty-state-text">{% trans "아직 팔로우한 사용자가 없습니다" %}</div>
                <div class="empty-state-subtext">{% trans "관심있는 사용자를 팔로우해보세요!" %}</div>
            </div>
        {% endif %}
    </div>
</div>

<script src="{% static 'js/sidebar.js' %}"></script>
<script>
    // CSRF 토큰 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 팔로우 토글
    document.addEventListener('click', (e) => {
        const followBtn = e.target.closest('.glt2-follow-btn');
        if (!followBtn) return;

        const userId = followBtn.dataset.id;
        if (!userId) return;

        fetch("{% url 'home:toggle_follow' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `user_id=${encodeURIComponent(userId)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'follow') {
                followBtn.textContent = '{% trans "Following" %}';
                followBtn.classList.add('following');
            } else if (data.status === 'unfollow') {
                followBtn.textContent = '{% trans "Follow" %}';
                followBtn.classList.remove('following');
            } else {
                alert(data.message);
            }
        })
        .catch(err => console.error('{% trans "팔로우 토글 오류:" %}', err));
    });

    // 유저 모달 열기
    function openUserModal(user_id) {
        const modalHTML = `
            <div id="llm-modal">
                <div class="modal-overlay" onclick="closeModal()"></div>
                <div class="modal-content">
                    <button class="close-btn" onclick="closeModal()">X</button>
                    <div id="llm-container" class="llm-container"></div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.style.overflow = "hidden";
        document.documentElement.style.overflow = "hidden";

        // 안전하게 URL 생성 (STATIC과 LANGUAGE_CODE 영향을 받지 않음)
        fetch(`/user_intro/${user_id}/`)
            .then(res => {
                if (!res.ok) throw new Error('{% trans "사용자 정보를 불러올 수 없습니다" %}');
                return res.text();
            })
            .then(html => {
                document.getElementById('llm-container').innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                alert('{% trans "사용자 정보를 불러오는 데 실패했습니다." %}');
                closeModal();
            });
    }

    function closeModal() {
        const modal = document.getElementById('llm-modal');
        if (modal) modal.remove();
        document.body.style.overflow = "auto";
        document.documentElement.style.overflow = "auto";
    }

    // 페이지 로드 후 애니메이션 적용
    document.addEventListener('DOMContentLoaded', function() {
        const userItems = document.querySelectorAll('.user-item');
        userItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(30px)';
            item.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>
</body>
</html>