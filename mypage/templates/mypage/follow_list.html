{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="background-color: #3b0d69;">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% trans "ë§ˆì´í˜ì´ì§€ - GALATEA" %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/mypage/follow_list.css' %}">

</head>
<body>
    <!-- ë°°ê²½ ì›í˜• íš¨ê³¼ -->
    <div class="circle-bg circle-1"></div>
    <div class="circle-bg circle-2"></div>
    <div class="circle-bg circle-3"></div>
    <div class="circle-bg circle-4"></div>
    <div class="circle-bg circle-5"></div>

    <!-- í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    {% include "common/sidebar.html" %}

{% load static %}
{% load i18n %}

<div class="main-content">

   <!-- íŒ”ë¡œì›Œ ì„¹ì…˜ -->
    <div class="section">
        <h2 class="section-title">
            {% trans "íŒ”ë¡œì›Œ ëª©ë¡" %}
            <span class="count-badge">{{ follower_list|length }}</span>
        </h2>

        {% if follower_list %}
            {% for follow in follower_list %}
                {% with target_user=follow.follower %}
                <div class="user-item" onclick="openUserModal({{ target_user.id }})" style="cursor: pointer;">
                    <div class="user-avatar">
                        {% if target_user.user_image %}
                            <img src="{{ target_user.user_image.url }}" alt="{{ target_user.username }}">
                        {% else %}
                            <img src="{% static 'images/default_user.png' %}" alt="{{ target_user.username }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3 class="username">{{ target_user.username }}</h3>
                    </div>

                </div>
                {% endwith %}
                
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¥</div>
                <div class="empty-state-text">{% trans "ì•„ì§ íŒ”ë¡œì›Œê°€ ì—†ìŠµë‹ˆë‹¤" %}</div>
                <div class="empty-state-subtext">{% trans "ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ê³¼ ì†Œí†µí•´ë³´ì„¸ìš”!" %}</div>
            </div>
        {% endif %}
    </div>

    <!-- íŒ”ë¡œì‰ ì„¹ì…˜ -->
    <div class="section">
        <h2 class="section-title">
            {% trans "íŒ”ë¡œì‰ ëª©ë¡" %}
            <span class="count-badge">{{ following_list|length }}</span>
        </h2>

        {% if following_list %}
            {% for follow in following_list %}
                {% with target_user=follow.following %}
                <div class="user-item" onclick="openUserModal({{ target_user.id }})" style="cursor: pointer;">
                    <div class="user-avatar" >
                        {% if target_user.user_image %}
                            <img src="{{ target_user.user_image.url }}" alt="{{ target_user.username }}">
                        {% else %}
                            <img src="{% static 'images/default_user.png' %}" alt="{{ target_user.username }}">
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <h3 class="username">{{ target_user.username }}</h3>
                    </div>

                </div>
                {% endwith %}
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">â•</div>
                <div class="empty-state-text">{% trans "ì•„ì§ íŒ”ë¡œìš°í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤" %}</div>
                <div class="empty-state-subtext">{% trans "ê´€ì‹¬ìˆëŠ” ì‚¬ìš©ìë¥¼ íŒ”ë¡œìš°í•´ë³´ì„¸ìš”!" %}</div>
            </div>
        {% endif %}
    </div>
</div>

<script src="{% static 'js/sidebar.js' %}"></script>
<script>
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // íŒ”ë¡œìš° í† ê¸€
    document.addEventListener('click', (e) => {
        const followBtn = e.target.closest('.glt2-follow-btn');
        if (!followBtn) return;

        const userId = followBtn.dataset.id;
        if (!userId) return;

        fetch("{% url 'home:toggle_follow' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `user_id=${encodeURIComponent(userId)}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'follow') {
                followBtn.textContent = '{% trans "Following" %}';
                followBtn.classList.add('following');
            } else if (data.status === 'unfollow') {
                followBtn.textContent = '{% trans "Follow" %}';
                followBtn.classList.remove('following');
            } else {
                alert(data.message);
            }
        })
        .catch(err => console.error('{% trans "íŒ”ë¡œìš° í† ê¸€ ì˜¤ë¥˜:" %}', err));
    });

    // ìœ ì € ëª¨ë‹¬ ì—´ê¸°
    function openUserModal(user_id) {
        const modalHTML = `
            <div id="llm-modal">
                <div class="modal-overlay" onclick="closeModal()"></div>
                <div class="modal-content">
                    <button class="close-btn" onclick="closeModal()">X</button>
                    <div id="llm-container" class="llm-container"></div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.style.overflow = "hidden";
        document.documentElement.style.overflow = "hidden";

        // ì•ˆì „í•˜ê²Œ URL ìƒì„± (STATICê³¼ LANGUAGE_CODE ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ)
        fetch(`/user_intro/${user_id}/`)
            .then(res => {
                if (!res.ok) throw new Error('{% trans "ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" %}');
                return res.text();
            })
            .then(html => {
                document.getElementById('llm-container').innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                alert('{% trans "ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." %}');
                closeModal();
            });
    }

    function closeModal() {
        const modal = document.getElementById('llm-modal');
        if (modal) modal.remove();
        document.body.style.overflow = "auto";
        document.documentElement.style.overflow = "auto";
    }

    // í˜ì´ì§€ ë¡œë“œ í›„ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
    document.addEventListener('DOMContentLoaded', function() {
        const userItems = document.querySelectorAll('.user-item');
        userItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(30px)';
            item.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>
</body>
</html>